# Self-Hosting Lessons Learned

This document captures limitations, issues, and potential improvements discovered while self-hosting Ruby2JS (transpiling Ruby2JS itself to JavaScript).

## Issues Fixed During Self-Hosting

### 1. Require Filter and Skip Pragma Ordering (Fixed)

**Problem:** The Require filter tried to load files before checking for `# Pragma: skip`, causing errors when skipping Ruby-only dependencies like `require 'json'`.

**Fix:** Added `has_skip_pragma?` method to the Require filter that checks for skip pragma before attempting to load files. This allows the Require filter to run before the Pragma filter while still respecting skip directives.

**Commit:** 4225573

### 2. Combiner Filter and Nested Begin Nodes (Fixed)

**Problem:** When the Require filter inlines files, it wraps content in `:begin` nodes. The Combiner filter couldn't merge reopened modules/classes across these nested begin boundaries.

**Fix:** Added `flatten_begins` method to recursively flatten nested `:begin` nodes before processing.

**Commit:** 4225573

### 3. IIFE Module const Declaration (Fixed)

**Problem:** Modules using IIFE pattern output `ModuleName = (() => {...})()` without `const`, causing ESM export issues.

**Fix:** Changed `module.rb` to use `casgn` instead of `lvasgn` for consistent `const` declarations.

**Commit:** 4225573

## Known Limitations / Areas for Improvement

### 1. Import Hoisting and Deduplication

**Issue:** When bundling multiple files with the Require filter, imports are hoisted to where they appear in each file. This can result in:
- Duplicate imports when multiple files import the same module
- Imports appearing in the middle of output (after polyfills)

**Current Workaround:** Post-processing scripts manually handle import placement.

**Potential Fix:** Add import deduplication and consolidation to the ESM filter or create a dedicated "bundle" filter that:
- Collects all imports from inlined files
- Deduplicates by module specifier
- Merges named imports from the same module
- Hoists all imports to the very top of output

### 2. Export Hoisting

**Issue:** Similar to imports, `export` statements from inlined files don't get consolidated.

**Potential Fix:** A bundle filter could collect exports and generate a single export block.

### 3. Polyfill Placement

**Issue:** Polyfills generated by the Polyfill filter appear inline where Ruby methods are used. When bundling, they may appear after imports or in unexpected locations.

**Current Workaround:** Post-processing extracts polyfills and moves them to a preamble.

**Potential Fix:** The Polyfill filter could have a "collect" mode that gathers all needed polyfills and emits them as a block at the start.

### 4. `.to_s` vs `.to_s!` Confusion

**Issue:** The Functions filter converts `.to_s` to `.toString()`. When you need the actual `to_s` method (e.g., on a custom class), you must use `.to_s!` which transpiles to `.to_s()`.

**Potential Fix:**
- Better documentation (added in javascript-first.md)
- Consider a pragma like `# Pragma: literal` to prevent method transformation on a line
- Or a class-level annotation to mark methods as "don't transform"

### 5. Method vs Property Access Ambiguity

**Issue:** Ruby2JS uses parentheses to distinguish method calls from property access. This works but requires discipline:
- `obj.foo` → property access
- `obj.foo()` → method call

Methods that should always be calls (like `.pop`, `.shift`) need special handling.

**Current Workaround:** The selfhost/converter filter has `ALWAYS_METHODS` list for methods that need forced call syntax.

**Potential Fix:**
- Add a pragma like `# Pragma: call` to force method call syntax
- Or maintain a built-in list of JavaScript methods that are always calls

### 6. Array Comparison

**Issue:** Ruby `==` on arrays does element-wise comparison. JavaScript `===` on arrays compares references.

**Current Workaround:** The selfhost/converter filter transforms specific patterns like `x.children[0..1] == [nil, :async]` to element-wise comparisons.

**Potential Fix:**
- General-purpose array equality helper
- Or pragma to trigger element-wise comparison

### 7. `respond_to?` Translation

**Issue:** Ruby's `respond_to?` becomes `'prop' in obj` in JavaScript, but this throws on primitives and null.

**Current Workaround:** The selfhost/converter filter wraps with typeof guard.

**Potential Fix:** Make this the default behavior in the Functions filter, or add a safer `respond_to?` polyfill.

### 8. Missing Combiner for Reopened Classes/Modules

**Issue:** Ruby allows reopening classes/modules to add methods. Without the Combiner filter, each definition becomes separate in JS output.

**Status:** Combiner filter exists but is not in DEFAULTS (by design - it's specialized).

**Documentation:** Should be better documented for JavaScript-first users who split code across files.

## Recommended Filter Chain for JavaScript-First

Based on self-hosting experience:

```ruby
filters: [
  Ruby2JS::Filter::Pragma,      # Must be early for skip to work
  Ruby2JS::Filter::Require,     # Inline files (respects skip pragma)
  Ruby2JS::Filter::Combiner,    # Merge reopened modules/classes
  # Domain-specific filters here (e.g., Selfhost::*)
  Ruby2JS::Filter::Polyfill,    # Add Ruby method polyfills
  Ruby2JS::Filter::Functions,   # Ruby→JS method mapping
  Ruby2JS::Filter::Return,      # Implicit returns
  Ruby2JS::Filter::ESM          # ES module syntax (should be last)
]
```

## Future Work Priorities

1. **High Priority:** Import/export consolidation for bundling
2. **Medium Priority:** Polyfill collection mode
3. **Low Priority:** Enhanced array comparison support
4. **Documentation:** Continue improving JavaScript-first guide

## Testing Self-Hosted Output

The self-hosted Ruby2JS can be tested with:

```bash
# Build the bundle
cd demo/selfhost
npm run build

# Test CLI
echo "puts 'hello'" | node dist/ruby2js.mjs

# Compare with Ruby version
echo "x ||= 1" | bin/ruby2js -e -
echo "x ||= 1" | node demo/selfhost/dist/ruby2js.mjs
```
