<!DOCTYPE html>
<html>
<head>
  <title>Rails-in-JS Blog</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; }
    h1 { color: #333; }
    a { color: #0066cc; cursor: pointer; }
    .article { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
    .comment { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; }
    form { margin: 20px 0; }
    label { display: block; margin: 10px 0 5px; font-weight: bold; }
    input[type="text"], textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    textarea { min-height: 100px; }
    button { background: #0066cc; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    button:hover { background: #0052a3; }
    button.danger { background: #cc0000; }
    button.danger:hover { background: #990000; }
    .errors { color: red; margin: 10px 0; padding: 10px; background: #fee; border-radius: 4px; }
    .meta { color: #666; font-size: 0.9em; }
    nav { margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #ddd; }
    nav a { margin-right: 15px; }
    #loading { text-align: center; padding: 40px; }
    #app { display: none; }
    .transpiled-badge { background: #4CAF50; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px; }
  </style>
</head>
<body>
  <div id="loading">Loading Rails-in-JS...<br><small>Powered by transpiled Ruby code</small></div>
  <div id="app">
    <nav>
      <a onclick="navigate('/')">Home</a>
      <a onclick="navigate('/articles')">Articles</a>
      <a onclick="navigate('/articles/new')">New Article</a>
      <span class="transpiled-badge">Transpiled Ruby â†’ JS</span>
    </nav>
    <main id="content"></main>
  </div>

  <script src="./node_modules/sql.js/dist/sql-wasm.js"></script>
  <script type="module">
    // === Polyfills for Ruby runtime ===
    window.Time = {
      now() {
        return { toString() { return new Date().toISOString(); } };
      }
    };

    // === Database Setup (using transpiled Schema) ===
    let db;
    let Article, Comment, Schema;

    async function initDatabase() {
      const SQL = await window.initSqlJs({
        locateFile: file => `./node_modules/sql.js/dist/${file}`
      });
      db = new SQL.Database();
      window.DB = db;

      // Load and run transpiled schema
      const schemaModule = await import('./dist/config/schema.js');
      Schema = schemaModule.Schema;
      Schema.create_tables(db);
    }

    // === Load Transpiled Models ===
    let Seeds;
    async function loadModels() {
      const models = await import('./dist/models/index.js');
      Article = models.Article;
      Comment = models.Comment;
      window.Article = Article;
      window.Comment = Comment;

      // Load and run seeds (needs models loaded first)
      const seedsModule = await import('./dist/db/seeds.js');
      Seeds = seedsModule.Seeds;
      Seeds.run();
    }

    // === Controllers (transpiled from Ruby) ===
    let ArticlesController, CommentsController;

    function getArticlesController() {
      return ArticlesController;
    }

    async function loadControllers() {
      const articlesModule = await import('./dist/controllers/articles_controller.js');
      const commentsModule = await import('./dist/controllers/comments_controller.js');
      ArticlesController = articlesModule.ArticlesController;
      CommentsController = commentsModule.CommentsController;
    }

    // === Router ===
    const routes = [
      { path: /^\/$/, handler: () => navigate('/articles') },
      { path: /^\/articles$/, handler: indexArticles },
      { path: /^\/articles\/new$/, handler: newArticle },
      { path: /^\/articles\/(\d+)$/, handler: (m) => showArticle(parseInt(m[1])) },
      { path: /^\/articles\/(\d+)\/edit$/, handler: (m) => editArticle(parseInt(m[1])) },
    ];

    function navigate(path) {
      history.pushState({}, '', path);
      dispatch(path);
    }

    function dispatch(path) {
      console.log(`Started GET "${path}"`);
      for (const route of routes) {
        const match = path.match(route.path);
        if (match) {
          route.handler(match);
          return;
        }
      }
      console.warn('  No route matched');
      document.getElementById('content').innerHTML = '<h1>404 Not Found</h1>';
    }

    // === Controller Actions (using transpiled Ruby controllers) ===
    function indexArticles() {
      console.log('Processing ArticlesController#index');
      const html = getArticlesController().index();
      console.log('  Rendering articles/index');
      document.getElementById('content').innerHTML = html;
    }

    function showArticle(id) {
      console.log(`Processing ArticlesController#show (id: ${id})`);
      try {
        const html = getArticlesController().show(id);
        console.log('  Rendering articles/show');
        document.getElementById('content').innerHTML = html;
      } catch (e) {
        console.error('  Error:', e.message || e);
        document.getElementById('content').innerHTML = '<h1>Article Not Found</h1>';
      }
    }

    function newArticle() {
      console.log('Processing ArticlesController#new');
      const html = getArticlesController().$new();
      console.log('  Rendering articles/new');
      document.getElementById('content').innerHTML = html;
    }

    function editArticle(id) {
      console.log(`Processing ArticlesController#edit (id: ${id})`);
      const html = getArticlesController().edit(id);
      console.log('  Rendering articles/edit');
      document.getElementById('content').innerHTML = html;
    }

    window.createArticle = function(event) {
      event.preventDefault();
      const params = {
        title: document.getElementById('title').value,
        body: document.getElementById('body').value
      };
      console.log('Processing ArticlesController#create');
      console.log('  Parameters:', params);
      const result = getArticlesController().create(params);
      if (result.redirect) {
        console.log(`  Redirected to ${result.redirect}`);
        navigate(result.redirect);
      } else if (result.render) {
        console.log('  Rendering articles/new (validation failed)');
        const html = getArticlesController().$new();
        document.getElementById('content').innerHTML = html;
      }
      return false;
    };

    window.updateArticle = function(event, id) {
      event.preventDefault();
      const params = {
        title: document.getElementById('title').value,
        body: document.getElementById('body').value
      };
      console.log(`Processing ArticlesController#update (id: ${id})`);
      console.log('  Parameters:', params);
      const result = getArticlesController().update(id, params);
      if (result.redirect) {
        console.log(`  Redirected to ${result.redirect}`);
        navigate(result.redirect);
      } else if (result.render) {
        console.log('  Rendering articles/edit (validation failed)');
        const html = getArticlesController().edit(id);
        document.getElementById('content').innerHTML = html;
      }
      return false;
    };

    window.deleteArticle = function(id) {
      if (confirm('Are you sure you want to delete this article?')) {
        console.log(`Processing ArticlesController#destroy (id: ${id})`);
        getArticlesController().destroy(id);
        console.log('  Redirected to /articles');
        navigate('/articles');
      }
    };

    window.createComment = function(event, articleId) {
      event.preventDefault();
      const params = {
        commenter: document.getElementById('commenter').value,
        body: document.getElementById('comment_body').value
      };
      console.log(`Processing CommentsController#create (article_id: ${articleId})`);
      console.log('  Parameters:', params);
      CommentsController.create(articleId, params);
      console.log(`  Redirected to /articles/${articleId}`);
      navigate(`/articles/${articleId}`);
      return false;
    };

    window.deleteComment = function(articleId, commentId) {
      if (confirm('Delete this comment?')) {
        console.log(`Processing CommentsController#destroy (article_id: ${articleId}, id: ${commentId})`);
        CommentsController.destroy(articleId, commentId);
        console.log(`  Redirected to /articles/${articleId}`);
        navigate(`/articles/${articleId}`);
      }
    };

    window.navigate = navigate;

    // === Initialize ===
    async function init() {
      try {
        await initDatabase();
        await loadModels();
        await loadControllers();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        // Handle browser back/forward
        window.addEventListener('popstate', () => dispatch(location.pathname));

        // Initial route
        dispatch(location.pathname || '/articles');
      } catch (e) {
        document.getElementById('loading').innerHTML = `<p style="color: red;">Error: ${e.message}</p><pre>${e.stack}</pre>`;
        console.error(e);
      }
    }

    init();
  </script>
</body>
</html>
