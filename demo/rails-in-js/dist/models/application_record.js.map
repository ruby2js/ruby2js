{"version":3,"file":"app/models/application_record.rb","sources":["app/models/application_record.rb"],"names":["ApplicationRecord","value","Object","attrs","key","sql","console","results","DB","id","stmt","obj","where_clause","values","conditions","JSON","record","result","field","options","now","Time","cols","placeholders","bindings","id_result","sets","clauses","columns","col","row","i"],"mappings":";;OAEO,MAAMA,iBAAN;EAAA,eA6BY,EA7BZ;EAAA,WA8BQ,EA9BR;EAAA,cA+BW,KA/BX;EAAA;;EAAA;EAAA;EAGL;oBAAA;EAAA,CAHK;;EAOL,OAAQ,KAAR;IACE,YAAOC;oBADT;EAAA,CAPK;;EAAA;EAYL;oBAAA;EAAA,CAZK;;EAgBL;4BAAA;EAAA,CAhBK;;EAoBL;4BAAA;EAAA,CApBK;;EAwBL;wBAAA;EAAA,CAxBK;;EA4BL,YAAe,MAAQ,EAAvB;IAKE,4BAAYE,KAAZ;MACEF,YAAQE,MAAMC,GAAN,CAAR;uBACA,CAAaA,cAAb,IAAyBH,KADzB;;MAGA;MAAA,KAAKG,GAAL,IAAYH,KAHZ;MAIA,IAAgBG,kBAAY,IAA5B,cAAOH;IALT;;IAQA,kCAAc,IAbhB;EAAA,CA5BK;;EAAA;EA6CL;IACEI,UAAM,iBAAiB,eAAjB;IACNC,cAAc,KAAK,SAAL,UAAwBD,GAAxB,EAAd;IACAE,cAAUC,QAAQH,GAAR;QACOE,kBAAiB,GAAlC,OAAO;WACP,sBAAsBA,QAAQ,CAAR,CAAtB,CALF;EAAA,CA7CK;;EAqDL,YAAc,EAAd;IAAA;IACEF,UAAM,iBAAiB,eAAjB;IACNC,cAAc,KAAK,SAAL,UAAwBD,GAAxB,aAA0CI,EAA1C,IAAd;IACAC,WAAOF,WAAWH,GAAX;IACPK,UAAU,CAACD,EAAD,CAAV;;QACGC;MACDC,MAAMD;MACNA;aACA,SAASC,GAAT;;MAEAD;MACAJ,cAAc,KAAK,SAAL,sBAAoCG,EAApC,EAAd;aACA,eAAM,GAAG,SAAH,sBAAkCA,EAAlC,EAAN;KAZJ;EAAA,CArDK;;EAqEL,eAAiB,UAAjB;IAAA;IACE,mBAAcI,MAAd,IAAuB,iBAAiBC,UAAjB;IACvBT,UAAM,iBAAiB,eAAjB,UAA0CO,YAA1C;IACNN,cAAc,KAAK,SAAL,UAAwBD,GAAxB,KAAgCU,eAAeF,MAAf,CAAhC,EAAd;IACAH,WAAOF,WAAWH,GAAX;IACPK,UAAUG,MAAV;;QACGH;MACDC,MAAMD;MACNA;aACA,SAASC,GAAT;;MAEAD;aACA;KAZJ;EAAA,CArEK;;EAqFL,aAAe,UAAf;IACE,mBAAcG,MAAd,IAAuB,iBAAiBC,UAAjB;IACvBT,UAAM,iBAAiB,eAAjB,UAA0CO,YAA1C;IACNN,cAAc,KAAK,SAAL,UAAwBD,GAAxB,KAAgCU,eAAeF,MAAf,CAAhC,EAAd;IACAH,WAAOF,WAAWH,GAAX;IACPK,UAAUG,MAAV;IACAN,cAAU;;IACV,OAAMG,WAAN;MACEH,aAAW,SAASG,kBAAT,CAAX;IADF;;IAGAA;WACAH,OAXF;EAAA,CArFK;;EAmGL,cAAgB,KAAhB;IACES,aAAS,SAASb,KAAT;IACTa;;;WACAA,MAHF;EAAA,CAnGK;;EAyGL;IACEC,aAAST,QAAQ,wBAAwB,eAAxB,EAAR;WACTS,OAAO,CAAP,SAAiB,CAAjB,EAAoB,CAApB,CAFF;EAAA,CAzGK;;EA8GL;IACEA,aAAST,QAAQ,iBAAiB,eAAjB,0BAAR;QACSS,iBAAgB,KAAKA,OAAO,CAAP,mBAA0B,GAAjE,OAAO;WACP,sBAAsBA,OAAO,CAAP,CAAtB,EAAiC,CAAjC,CAHF;EAAA,CA9GK;;EAoHL;IACEA,aAAST,QAAQ,iBAAiB,eAAjB,2BAAR;QACSS,iBAAgB,KAAKA,OAAO,CAAP,mBAA0B,GAAjE,OAAO;WACP,sBAAsBA,OAAO,CAAP,CAAtB,EAAiC,CAAjC,CAHF;EAAA,CApHK;;EAAA;EA2HL;2BAAA;EAAA,CA3HK;;EA+HL;4BAAA;EAAA,CA/HK;;EAmIL;aACsB,WAApB,OAAO;2BAEP,OACE,WADF,OAGE,WANJ;EAAA,CAnIK;;EAAA;EA6IL,OAAW,KAAX;;IACE,4BAAYd,KAAZ;uBACE,CAAaC,cAAb,IAAyBD,MAAMC,GAAN;IAD3B;;eAGA,KAJF;EAAA,CA7IK;;EAAA;EAoJL;2BACE,OAAO;IACPC,UAAM,eAAe,2BAAf;IACNC,cAAc,KAAK,qBAAL,aAAiCD,GAAjC,0BAAd;IACAG,OAAOH,GAAP,EAAY,WAAZ;IACA,mBAAc;WACd,IANF;EAAA,CApJK;;EA6JL;IACE,gBAAW;QACX;;IACA;IAAA,iBAAG,UAAkB,CAArB;MACEC,aAAa,sBAAb;IADF;;wBAGA,WAAmB,CANrB;EAAA,CA7JK;;EAsKL;eAAA;EAAA,CAtKK;;EAAA;EAAA;EA2KL,sBAA0B,KAA1B;IACEL,6BAAQ,CAAaiB,gBAAb;;QACLjB,iBAAcA,kCAA2B;0BAC1C,MAAc,GAAGiB,KAAH,iBAAd;KAHJ;EAAA,CA3KK;;EAkLL,oBAAwB,OAAO,OAA/B;IACEjB,6BAAQ,CAAaiB,gBAAb;;QACLC,mBAAqBlB,eAAekB;0BACrC,MAAc,GAAGD,KAAH,6BAAqCC,eAArC,cAAd;KAHJ;EAAA,CAlLK;;EA2LL;IACEC,UAAMC;qBACN,cAA6BD;qBAC7B,cAA6BA;IAE7BE,WAAO;IACPC,mBAAe;IACfV,aAAS;IACTW,eAAW;;IAEX;MACE,IAAQpB,OAAO,IAAf;MACAkB,UAAQlB,GAAR,CADA;MAEAmB,kBAAgB,GAAhB,CAFA;MAGAV,6BAAU,CAAaT,GAAb,CAAV,CAHA;MAIAoB,cAAY,CAACpB,GAAD,mBAAM,CAAaA,GAAb,CAAN,CAAZ;IALF;;IAQAC,UAAM,eAAe,2BAAf,KAAyCiB,UAAU,IAAV,CAAzC,aAAqEC,kBAAkB,IAAlB,CAArE;IACNjB,cAAc,KAAK,qBAAL,YAAgCD,GAAhC,KAAwCU,eAAeS,QAAf,CAAxC,EAAd;IACAhB,OAAOH,GAAP,EAAYQ,MAAZ;IAEAY,gBAAYjB,QAAQ,4BAAR;IACZ,YAAOiB,UAAU,CAAV,SAAoB,CAApB,EAAuB,CAAvB;qBACP;IACA;;IACA;IAAA,mBAAc;IACdnB,YAAY,KAAK,qBAAL,4BAAZ;WACA,IA5BF;EAAA,CA3LK;;EA0NL;qBACE,cAA6Be;IAE7BK,WAAO;IACPb,aAAS;IACTW,eAAW;;IAEX;MACE,IAAQpB,OAAO,IAAf;MACAsB,UAAQ,GAAGtB,GAAH,MAAR,CADA;MAEAS,6BAAU,CAAaT,GAAb,CAAV,CAFA;MAGAoB,cAAY,CAACpB,GAAD,mBAAM,CAAaA,GAAb,CAAN,CAAZ;IAJF;;IAMAS;IACAW,cAAY,CAAC,IAAD,YAAZ;IAEAnB,UAAM,UAAU,2BAAV,QAAuCqB,UAAU,IAAV,CAAvC;IACNpB,cAAc,KAAK,qBAAL,YAAgCD,GAAhC,KAAwCU,eAAeS,QAAf,CAAxC,EAAd;IACAhB,OAAOH,GAAP,EAAYQ,MAAZ;IACAP,YAAY,KAAK,qBAAL,4BAAZ;WACA,IApBF;EAAA,CA1NK;;EAiPL,mBAAqB,UAArB;IACEqB,cAAU;IACVd,aAAS;;IACT,4BAAYC,UAAZ;MACEa,aAAW,GAAGvB,GAAH,MAAX;MACAS,YAAUC,WAAWV,GAAX,CAAV;IAFF;;WAIA,CAACuB,aAAa,OAAb,CAAD,EAAwBd,MAAxB,CAPF;EAAA,CAjPK;;EA2PL,wBAA0B,MAA1B;IACEe,cAAUX;;WACVA,mBAAsB,GAAtB;MACEN,UAAM;MACNiB,iBAA4B,GAAD,EAAM,CAAjC,KACEjB,IAAIkB,GAAJ,IAAWC,IAAIC,CAAJ;aAEb,SAASpB,GAAT,CALF;IAAA,EAFF;EAAA;AA3PK","sourcesContent":["# Base class for all models\n# Transpiled to JavaScript, runs on sql.js\nexport class ApplicationRecord\n  # Use underscore-prefixed properties instead of private fields\n  # so subclasses can access them (JS private fields don't inherit)\n  def id\n    @_id\n  end\n\n  def id=(value)\n    @_id = value\n  end\n\n  # Expose internal properties for subclass access (JS private fields don't inherit)\n  def _id\n    @_id\n  end\n\n  def _attributes\n    @_attributes\n  end\n\n  def attributes\n    @_attributes\n  end\n\n  def errors\n    @_errors\n  end\n\n  def initialize(attrs = {})\n    @_attributes = {}\n    @_errors = []\n    @_persisted = false\n\n    Object.keys(attrs).each do |key|\n      value = attrs[key]\n      @_attributes[key.to_s] = value\n      # Also set as direct property for easy access (article.title instead of article._attributes['title'])\n      self[key] = value\n      @_id = value if key.to_s == 'id'\n    end\n\n    @_persisted = true if @_id\n  end\n\n  # Class methods\n  def self.all\n    sql = \"SELECT * FROM #{self.table_name}\"\n    console.debug(\"  #{self.name} Load  #{sql}\")\n    results = DB.exec(sql)\n    return [] unless results.length > 0\n    self.result_to_models(results[0])\n  end\n\n  def self.find(id)\n    sql = \"SELECT * FROM #{self.table_name} WHERE id = ?\"\n    console.debug(\"  #{self.name} Load  #{sql}  [[\\\"id\\\", #{id}]]\")\n    stmt = DB.prepare(sql)\n    stmt.bind([id])\n    if stmt.step()\n      obj = stmt.getAsObject()\n      stmt.free()\n      self.new(obj)\n    else\n      stmt.free()\n      console.error(\"  #{self.name} not found with id=#{id}\")\n      raise \"#{self.name} not found with id=#{id}\"\n    end\n  end\n\n  def self.find_by(conditions)\n    where_clause, values = self.build_where(conditions)\n    sql = \"SELECT * FROM #{self.table_name} WHERE #{where_clause} LIMIT 1\"\n    console.debug(\"  #{self.name} Load  #{sql}  #{JSON.stringify(values)}\")\n    stmt = DB.prepare(sql)\n    stmt.bind(values)\n    if stmt.step()\n      obj = stmt.getAsObject()\n      stmt.free()\n      self.new(obj)\n    else\n      stmt.free()\n      nil\n    end\n  end\n\n  def self.where(conditions)\n    where_clause, values = self.build_where(conditions)\n    sql = \"SELECT * FROM #{self.table_name} WHERE #{where_clause}\"\n    console.debug(\"  #{self.name} Load  #{sql}  #{JSON.stringify(values)}\")\n    stmt = DB.prepare(sql)\n    stmt.bind(values)\n    results = []\n    while stmt.step()\n      results << self.new(stmt.getAsObject())\n    end\n    stmt.free()\n    results\n  end\n\n  def self.create(attrs)\n    record = self.new(attrs)\n    record.save  # Access as getter, not method call\n    record\n  end\n\n  def self.count\n    result = DB.exec(\"SELECT COUNT(*) FROM #{self.table_name}\")\n    result[0].values[0][0]\n  end\n\n  def self.first\n    result = DB.exec(\"SELECT * FROM #{self.table_name} ORDER BY id ASC LIMIT 1\")\n    return nil unless result.length > 0 && result[0].values.length > 0\n    self.result_to_models(result[0])[0]\n  end\n\n  def self.last\n    result = DB.exec(\"SELECT * FROM #{self.table_name} ORDER BY id DESC LIMIT 1\")\n    return nil unless result.length > 0 && result[0].values.length > 0\n    self.result_to_models(result[0])[0]\n  end\n\n  # Instance methods\n  def persisted?\n    @_persisted\n  end\n\n  def new_record?\n    !@_persisted\n  end\n\n  def save\n    return false unless is_valid\n\n    if @_persisted\n      do_update  # Access as getter\n    else\n      do_insert  # Access as getter\n    end\n  end\n\n  def update(attrs)\n    Object.keys(attrs).each do |key|\n      @_attributes[key.to_s] = attrs[key]\n    end\n    save  # Access as getter\n  end\n\n  def destroy\n    return false unless @_persisted\n    sql = \"DELETE FROM #{self.class.table_name} WHERE id = ?\"\n    console.debug(\"  #{self.class.name} Destroy  #{sql}  [[\\\"id\\\", #{@_id}]]\")\n    DB.run(sql, [@_id])\n    @_persisted = false\n    true\n  end\n\n  def is_valid\n    @_errors = []\n    validate()  # Call as method - subclasses define validate()\n    if @_errors.length > 0\n      console.warn(\"  Validation failed:\", @_errors)\n    end\n    @_errors.length == 0\n  end\n\n  def validate\n    # Override in subclasses\n  end\n\n  # Validation helpers\n  def validates_presence_of(field)\n    value = @_attributes[field.to_s]\n    if value.nil? || value.to_s.strip.length == 0\n      @_errors.push(\"#{field} can't be blank\")\n    end\n  end\n\n  def validates_length_of(field, options)\n    value = @_attributes[field.to_s].to_s\n    if options[:minimum] && value.length < options[:minimum]\n      @_errors.push(\"#{field} is too short (minimum is #{options[:minimum]} characters)\")\n    end\n  end\n\n  private\n\n  def do_insert\n    now = Time.now().to_s\n    @_attributes['created_at'] = now\n    @_attributes['updated_at'] = now\n\n    cols = []\n    placeholders = []\n    values = []\n    bindings = []\n\n    Object.keys(@_attributes).each do |key|\n      next if key == 'id'\n      cols << key\n      placeholders << '?'\n      values << @_attributes[key]\n      bindings << [key, @_attributes[key]]\n    end\n\n    sql = \"INSERT INTO #{self.class.table_name} (#{cols.join(', ')}) VALUES (#{placeholders.join(', ')})\"\n    console.debug(\"  #{self.class.name} Create  #{sql}  #{JSON.stringify(bindings)}\")\n    DB.run(sql, values)\n\n    id_result = DB.exec('SELECT last_insert_rowid()')\n    @_id = id_result[0].values[0][0]\n    @_attributes['id'] = @_id\n    self['id'] = @_id  # Also set as direct property\n    @_persisted = true\n    console.log(\"  #{self.class.name} Create (id: #{@_id})\")\n    true\n  end\n\n  def do_update\n    @_attributes['updated_at'] = Time.now().to_s\n\n    sets = []\n    values = []\n    bindings = []\n\n    Object.keys(@_attributes).each do |key|\n      next if key == 'id'\n      sets << \"#{key} = ?\"\n      values << @_attributes[key]\n      bindings << [key, @_attributes[key]]\n    end\n    values << @_id\n    bindings << ['id', @_id]\n\n    sql = \"UPDATE #{self.class.table_name} SET #{sets.join(', ')} WHERE id = ?\"\n    console.debug(\"  #{self.class.name} Update  #{sql}  #{JSON.stringify(bindings)}\")\n    DB.run(sql, values)\n    console.log(\"  #{self.class.name} Update (id: #{@_id})\")\n    true\n  end\n\n  def self.build_where(conditions)\n    clauses = []\n    values = []\n    Object.keys(conditions).each do |key|\n      clauses << \"#{key} = ?\"\n      values << conditions[key]\n    end\n    [clauses.join(' AND '), values]\n  end\n\n  def self.result_to_models(result)\n    columns = result.columns\n    result.values.map do |row|\n      obj = {}\n      columns.each_with_index do |col, i|\n        obj[col] = row[i]\n      end\n      self.new(obj)\n    end\n  end\nend\n"]}