<%# Shared demo template - works with both Sinatra and Bridgetown
     @live = true for Bridgetown (Shoelace), false for Sinatra (plain HTML) -%>
<% unless @live %>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruby2JS Demo</title>
  <base href="/">
<% end %>
<style>
  .js.editor { background-color: #ffffcc }
  .ruby.editor { resize: vertical; overflow: auto; height: 200px; background-color: #ffeeee; margin-bottom: 5px; }
  .ruby .cm-wrap { background-color: #ffeeee; height: 100% }
  .js .cm-wrap { background-color: #ffffdd; height: 100% }
  .ruby .cm-wrap .cm-content .cm-activeLine { background-color: #ffdddd; margin-right: 2px }
  .js .cm-wrap .cm-content .cm-activeLine { background-color: #ffffcc; margin-right: 2px }

  .unloc {background-color: yellow}
  .loc {background-color: white}
  .loc span.hidden, .unloc span.hidden {font-size: 0}
  .container.narrow-container {padding: 0; margin: 0 3%; max-width: 91%}
  .exception {background-color:#ff0; margin: 1em 0; padding: 1em; border: 4px solid red; border-radius: 1em}

<% if @live %>
  sl-menu { display: none }
  .narrow-container pre {padding: 0 1rem}
  .narrow-container h1.title, .narrow-container h2.title {margin: 0.5rem 0}
<% else %>
  /* Base reset and fonts */
  :root {
    --primary-color: #c92613;
    --primary-hover: #a51f0f;
    --text-color: #363636;
    --text-light: #4a4a4a;
    --bg-light: #f5f5f5;
    --bg-footer: #1a1a2e;
    --border-color: #dbdbdb;
    --link-color: #3273dc;
  }

  * { box-sizing: border-box; }

  html { font-size: 16px; }

  body {
    margin: 0;
    font-family: BlinkMacSystemFont, -apple-system, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: var(--text-color);
    background-color: #fff;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  main { flex: 1; padding: 1rem 0 2rem; }

  a { color: var(--link-color); text-decoration: none; }
  a:hover { text-decoration: underline; }

  h1, h2, h3 { color: var(--text-color); font-weight: 600; margin: 0.5em 0; }
  h1 { font-size: 1.5rem; }
  h2 { font-size: 1.25rem; margin-top: 1rem; }

  /* Navbar */
  .navbar {
    background-color: var(--bg-footer);
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .navbar-brand {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .navbar-brand a {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: white;
    font-weight: 600;
    font-size: 1.25rem;
  }

  .navbar-brand a:hover { text-decoration: none; opacity: 0.9; }

  .navbar-brand svg {
    height: 2.5rem;
    width: 2.5rem;
  }

  .navbar-menu {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .navbar-menu a {
    color: rgba(255,255,255,0.9);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .navbar-menu a:hover {
    background-color: rgba(255,255,255,0.1);
    text-decoration: none;
    color: white;
  }

  /* Footer */
  .footer {
    background-color: var(--bg-footer);
    color: rgba(255,255,255,0.8);
    padding: 2rem 1rem 1rem;
    margin-top: auto;
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
  }

  .footer-section {
    flex: 1;
    min-width: 200px;
  }

  .footer-section h4 {
    color: white;
    margin-bottom: 1rem;
    font-size: 1rem;
  }

  .footer-section a {
    color: rgba(255,255,255,0.7);
    display: block;
    margin-bottom: 0.5rem;
  }

  .footer-section a:hover { color: white; }

  .footer-bottom {
    text-align: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 0.875rem;
    color: rgba(255,255,255,0.5);
  }

  .footer-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .footer-logo svg { height: 2.5rem; width: 2.5rem; }

  /* Form elements */
  textarea.ruby {
    background-color: #ffeeee;
    margin-bottom: 0.5rem;
    width: 100%;
    padding: 0.75rem;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.9rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    resize: vertical;
  }

  textarea.ruby:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(201, 38, 19, 0.2);
  }

  pre.js {
    background-color: #ffffee;
    padding: 1rem;
    border: 1px solid #eee;
    border-radius: 4px;
    overflow-x: auto;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.9rem;
  }

  pre.js.exception {
    background-color: #ff0;
    border: 4px solid red;
    border-radius: 1em;
  }

  /* Options bar */
  .options {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background-color: var(--bg-light);
    border-radius: 4px;
  }

  .options label {
    font-size: 0.9rem;
    color: var(--text-light);
  }

  .options input[type="checkbox"] {
    margin-right: 0.25rem;
    accent-color: var(--primary-color);
  }

  .options select {
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: white;
    font-size: 0.9rem;
  }

  /* Buttons */
  .btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: center;
    border: 1px solid transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    color: white;
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-primary:hover {
    background-color: var(--primary-hover);
    border-color: var(--primary-hover);
  }

  .btn-outline {
    color: var(--text-color);
    background-color: white;
    border-color: var(--border-color);
  }

  .btn-outline:hover {
    background-color: var(--bg-light);
  }

  /* Dropdowns */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 180px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 4px;
    z-index: 100;
    padding: 0.5rem 0;
  }

  .dropdown-content div {
    padding: 0.375rem 1rem;
    cursor: pointer;
  }

  .dropdown-content div:hover {
    background-color: var(--bg-light);
  }

  .dropdown-content input[type="checkbox"] {
    margin-right: 0.5rem;
    accent-color: var(--primary-color);
  }

  .dropdown-content span {
    font-size: 0.9rem;
    cursor: pointer;
  }

  /* Container */
  .container {
    width: 100%;
    max-width: 1200px;
    padding: 0 1rem;
    margin: 0 auto;
  }

  @media (max-width: 768px) {
    .navbar { flex-direction: column; gap: 0.5rem; }
    .navbar-menu { flex-wrap: wrap; justify-content: center; }
    .footer-content { flex-direction: column; }
  }
<% end %>
</style>
<% unless @live %>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <a href="/">
        <%= ruby2js_logo %>
        <span>Ruby2JS</span>
      </a>
    </div>
    <div class="navbar-menu">
      <a href="https://www.ruby2js.com/docs/">Documentation</a>
      <a href="https://www.ruby2js.com/examples/">Examples</a>
      <a href="https://github.com/ruby2js/ruby2js" target="_blank">GitHub</a>
    </div>
  </nav>
  <main>
<% end %>

<div class="container narrow-container">
  <% if @live %>
    <h1 class="title is-size-4">Ruby</h1>
    <sl-dialog id="option" label="Option">
      <sl-input></sl-input>
      <sl-button slot="footer" type="primary">Close</sl-button>
    </sl-dialog>
  <% else %>
    <h1>Ruby Source</h1>
  <% end %>

  <form method="post">
    <div<%= @live ? ' data-controller="ruby"' : '' %>>
      <textarea class="ruby form-control" name="ruby" rows="8" placeholder="Ruby source"><%= @ruby || 'puts "Hello world!"' %></textarea>
    </div>

    <div class="options"<%= @live ? ' data-controller="options"' : '' %>>
      <input class="btn btn-primary" type="submit" value="Convert" style="display: none">

      <% # Preset checkbox %>
      <% if @live %>
        <sl-checkbox id="preset" name="preset"<%= @preset ? ' checked' : '' %>>Use Preset</sl-checkbox>
      <% else %>
        <input type="checkbox" id="preset" name="preset"<%= @preset ? ' checked' : '' %>>
        <label for="preset">Use Preset</label>
      <% end %>

      <label for="eslevel">ESLevel:</label>
      <% if @live %>
        <sl-dropdown id="eslevel" name="eslevel">
          <sl-button slot="trigger" caret><%= @eslevel || 'default' %></sl-button>
          <sl-menu>
            <sl-menu-item type="checkbox"<%= (!@eslevel || @eslevel == 'default') ? ' checked' : '' %>>default</sl-menu-item>
            <% @eslevel_list.each do |level| %>
              <sl-menu-item type="checkbox" value="<%= level %>"<%= @eslevel == level ? ' checked' : '' %>><%= level %></sl-menu-item>
            <% end %>
          </sl-menu>
        </sl-dropdown>
      <% else %>
        <select name="eslevel" id="eslevel">
          <option<%= (!@eslevel || @eslevel == 'default') ? ' selected' : '' %>>default</option>
          <% @eslevel_list.each do |level| %>
            <option value="<%= level %>"<%= @eslevel == level ? ' selected' : '' %>><%= level %></option>
          <% end %>
        </select>
      <% end %>

      <% # Show AST checkbox %>
      <% if @live %>
        <sl-checkbox id="ast" name="ast"<%= @ast ? ' checked' : '' %>>Show AST</sl-checkbox>
      <% else %>
        <input type="checkbox" id="ast" name="ast"<%= @ast ? ' checked' : '' %>>
        <label for="ast">Show AST</label>
      <% end %>

      <% # Filters dropdown %>
      <% if @live %>
        <sl-dropdown id="filters" close-on-select="false">
          <sl-button slot="trigger" caret>Filters</sl-button>
          <sl-menu>
            <% @filter_list.each do |filter| %>
              <sl-menu-item type="checkbox" name="<%= filter %>"<%= @selected.include?(filter) ? ' checked' : '' %>><%= filter %></sl-menu-item>
            <% end %>
          </sl-menu>
        </sl-dropdown>
      <% else %>
        <div class="dropdown" id="filters">
          <button class="btn btn-outline" type="button">Filters</button>
          <div class="dropdown-content">
            <% @filter_list.each do |filter| %>
              <div>
                <input type="checkbox" id="filter-<%= filter %>" name="<%= filter %>"<%= @selected.include?(filter) ? ' checked' : '' %>>
                <span><%= filter %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% # Options dropdown %>
      <% if @live %>
        <sl-dropdown id="options" close-on-select="false">
          <sl-button slot="trigger" caret>Options</sl-button>
          <sl-menu>
            <% @option_list.each do |option, has_args| %>
              <% next if option == 'preset' || option == 'filter' || option.start_with?('require_') %>
              <% show_args = option == 'truthy' ? false : has_args %>
              <sl-menu-item type="checkbox" name="<%= option %>"<%= @options_checked[option.to_sym] ? ' checked' : '' %><%= show_args ? ' data-args="true"' : '' %>><%= option %></sl-menu-item>
            <% end %>
          </sl-menu>
        </sl-dropdown>
      <% else %>
        <div class="dropdown" id="options">
          <button class="btn btn-outline" type="button">Options</button>
          <div class="dropdown-content">
            <% @option_list.each do |option, has_args| %>
              <% next if option == 'preset' || option == 'filter' || option.start_with?('require_') %>
              <% show_args = option == 'truthy' ? false : has_args %>
              <div>
                <input type="checkbox" id="option-<%= option %>" name="<%= option %>"<%= @options_checked[option.to_sym] ? ' checked' : '' %><%= show_args ? ' data-args="true"' : '' %>>
                <span><%= option %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </form>

  <% unless @live %>
  <script>
    // Determine base URL and what filters and options are selected
    let base = document.querySelector('base')?.href || window.location.origin + '/';
    base = new URL(base).pathname;
    let filters = new Set(window.location.pathname.slice(base.length).split('/'));
    filters.delete('');
    let options = {};
    for (let match of window.location.search.matchAll(/(\w+)(=([^&]*))?/g)) {
      options[match[1]] = match[3] && decodeURIComponent(match[3]);
    }
    if (options.filter) options.filter.split(',').forEach(option => filters.add(option));

    // Debounce function for live updates
    let debounceTimer;
    function debounce(func, delay = 300) {
      return function(...args) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function updateLocation(force = false) {
      let location = new URL(base, window.location);
      location.pathname += Array.from(filters).join('/');

      let search = [];
      for (let [key, value] of Object.entries(options)) {
        search.push(value === undefined ? key : `${key}=${encodeURIComponent(value)}`);
      }

      location.search = search.length === 0 ? "" : `${search.join('&')}`;
      if (!force && window.location.toString() == location.toString()) return;

      history.replaceState({}, null, location.toString());
      convert();
    }

    function convert() {
      // Get current ruby code and options
      let ruby = document.querySelector('textarea[name=ruby]').value;
      let ast = document.getElementById('ast').checked;
      let preset = document.getElementById('preset').checked;
      let eslevel = document.getElementById('eslevel').value;

      if (!ruby.trim()) {
        document.getElementById('js').style.display = 'none';
        return;
      }

      // Build request body with all current options
      let body = { ruby, ast };
      if (preset) body.preset = true;
      if (eslevel && eslevel !== 'default') body.eslevel = eslevel;

      // Add selected filters
      Array.from(filters).forEach(f => body[f] = 'on');

      // Add selected options
      for (let [key, value] of Object.entries(options)) {
        if (key === 'preset' || key.startsWith('es')) continue; // handled above
        body[key] = value === undefined ? 'on' : value;
      }

      let headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      };

      fetch(window.location.href, {
        method: 'POST',
        headers,
        body: JSON.stringify(body)
      })
      .then(response => response.json())
      .then(json => {
        let jsOutput = document.querySelector('#js pre');
        let jsSection = document.getElementById('js');

        if (json.exception) {
          jsOutput.textContent = json.exception;
          jsOutput.classList.add('exception');
        } else {
          jsOutput.textContent = json.js;
          jsOutput.classList.remove('exception');
        }
        jsSection.style.display = 'block';

        let parsed = document.getElementById('parsed');
        if (json.parsed) {
          parsed.querySelector('pre').innerHTML = json.parsed.replace(/<\/?pre>/g, '');
          parsed.style.display = 'block';
        } else {
          parsed.style.display = 'none';
        }

        let filtered = document.getElementById('filtered');
        if (json.filtered) {
          filtered.querySelector('pre').innerHTML = json.filtered.replace(/<\/?pre>/g, '');
          filtered.style.display = 'block';
        } else {
          filtered.style.display = 'none';
        }
      })
      .catch(err => {
        console.error(err);
      });
    }

    // Live update on textarea input
    const textarea = document.querySelector('textarea[name=ruby]');
    textarea.addEventListener('input', debounce(() => convert(), 400));

    // Show dropdowns
    let dropdowns = document.querySelectorAll('.dropdown');
    for (let dropdown of dropdowns) {
      let content = dropdown.querySelector('.dropdown-content');

      // Toggle dropdown on button click
      dropdown.querySelector('button').addEventListener('click', event => {
        event.preventDefault();
        const isOpen = content.style.display === 'block';
        // Close all other dropdowns
        document.querySelectorAll('.dropdown-content').forEach(d => d.style.display = 'none');
        content.style.display = isOpen ? 'none' : 'block';
      });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', event => {
      if (!event.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(d => d.style.display = 'none');
      }
    });

    // Add/remove eslevel options
    document.getElementById('eslevel').addEventListener('change', event => {
      let value = event.target.value;
      if (value !== "default") options['es' + value] = undefined;
      for (let option of event.target.querySelectorAll('option')) {
        if (option.value === 'default' || option.value === value) continue;
        delete options['es' + option.value];
      }
      updateLocation();
    });

    // Add/remove preset option
    document.getElementById('preset').addEventListener('change', event => {
      if (event.target.checked) {
        options['preset'] = undefined;
      } else {
        delete options['preset'];
      }
      updateLocation();
    });

    // Add/remove filters based on checkbox
    let filterDropdown = document.getElementById('filters');
    for (let filter of filterDropdown.querySelectorAll('input[type=checkbox]')) {
      filter.addEventListener('click', event => {
        let name = event.target.name;
        if (!filters.delete(name)) filters.add(name);
        updateLocation();
      });
    }

    // Add/remove options based on checkbox
    let optionsDropdown = document.getElementById('options');
    for (let option of optionsDropdown.querySelectorAll('input[type=checkbox]')) {
      option.addEventListener('click', event => {
        let name = event.target.name;

        if (name in options) {
          delete options[name];
        } else if (option.dataset.args) {
          let value = prompt(name);
          if (value !== null) {
            options[name] = value;
          } else {
            event.target.checked = false;
            return;
          }
        } else {
          options[name] = undefined;
        }

        updateLocation();
      });
    }

    // Allow update of option value by clicking label
    for (let span of document.querySelectorAll('input[data-args] + span')) {
      span.addEventListener('click', event => {
        let input = span.previousElementSibling;
        let name = input.name;
        if (input.checked) {
          let value = prompt(name, decodeURIComponent(options[name] || ''));
          if (value !== null) {
            options[name] = value;
            updateLocation();
          }
        }
      });
    }

    // Refresh on "Show AST" change
    document.getElementById('ast').addEventListener('change', () => convert());

    // Initial conversion if there's content
    if (textarea.value.trim()) {
      convert();
    }
  </script>
  <% end %>

  <% if @error %>
    <div class="exception"><%= @error %></div>
  <% end %>

  <div id="parsed" style="display: <%= @ast && @parsed ? 'block' : 'none' %>">
    <h2 class="title is-size-6">AST</h2>
    <pre><%= @parsed_html %></pre>
  </div>

  <div id="filtered" style="display: <%= @ast && @filtered_html ? 'block' : 'none' %>">
    <h2 class="title is-size-6">filtered AST</h2>
    <pre><%= @filtered_html %></pre>
  </div>

  <div id="js"<%= @live ? ' data-controller="js"' : '' %> style="display: <%= @ruby ? 'block' : 'none' %>">
    <h2 class="title is-size-4">JavaScript</h2>
    <pre class="js"><%= @js_output %></pre>
  </div>
</div>

<% unless @live %>
  </main>
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <div class="footer-logo">
          <%= ruby2js_logo %>
          <strong style="color: white;">Ruby2JS</strong>
        </div>
        <p>An extensible Ruby to modern JavaScript transpiler.</p>
        <p style="font-size: 0.8rem; margin-top: 1rem; opacity: 0.6;">
          Source code licensed MIT
        </p>
      </div>
      <div class="footer-section">
        <h4>Documentation</h4>
        <a href="https://www.ruby2js.com/docs/">Getting Started</a>
        <a href="https://www.ruby2js.com/docs/filters/">Filters</a>
        <a href="https://www.ruby2js.com/docs/options/">Options</a>
      </div>
      <div class="footer-section">
        <h4>Contribute</h4>
        <a href="https://github.com/ruby2js/ruby2js/issues">Browse Issues</a>
        <a href="https://github.com/ruby2js/ruby2js/pulls">Pull Requests</a>
        <a href="https://github.com/ruby2js/ruby2js/discussions">Discussions</a>
      </div>
    </div>
    <div class="footer-bottom">
      Brought to you by Jared White and Sam Ruby
    </div>
  </footer>
</body>
</html>
<% end %>
