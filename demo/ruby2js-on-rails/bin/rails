#!/usr/bin/env bash
# Ruby2JS-on-Rails command runner
# Supports a subset of Rails commands for familiarity

set -e

usage() {
  echo "Usage: bin/rails COMMAND [OPTIONS]"
  echo ""
  echo "Commands:"
  echo "  server    Start the development server"
  echo "  build     Build static assets for deployment"
  echo ""
  echo "Server options:"
  echo "  -p, --port PORT       Use specified port (default: 3000)"
  echo "  -b, --binding HOST    Bind to HOST (default: localhost)"
  echo "  -e, --environment ENV Use environment (development/production)"
  echo "  --runtime RUNTIME     Use runtime: node, bun, or deno (for server databases)"
  echo ""
  echo "Database determines runtime (set in config/database.yml):"
  echo "  dexie, sqljs         -> browser (SPA mode)"
  echo "  better_sqlite3, pg   -> node, bun, or deno (default: node)"
  echo ""
  echo "Note: This is Ruby2JS-on-Rails, a transpiled subset of Rails patterns."
  echo "      Not all Rails commands are supported."
}

# Default values
PORT=3000
HOST="localhost"
ENV="development"
RUNTIME=""

# Parse command
COMMAND="${1:-}"
shift 2>/dev/null || true

case "$COMMAND" in
  server|s)
    # Parse options
    while [[ $# -gt 0 ]]; do
      case "$1" in
        -p|--port)
          PORT="$2"
          shift 2
          ;;
        -b|--binding)
          HOST="$2"
          shift 2
          ;;
        -e|--environment)
          ENV="$2"
          shift 2
          ;;
        --runtime)
          RUNTIME="$2"
          shift 2
          ;;
        *)
          echo "Unknown option: $1"
          usage
          exit 1
          ;;
      esac
    done

    # Set environment variables for build script
    export NODE_ENV="$ENV"
    export RAILS_ENV="$ENV"
    export PORT="$PORT"
    export HOST="$HOST"
    [[ -n "$RUNTIME" ]] && export RUNTIME

    # Build determines target from database.yml, validates runtime compatibility
    # Then outputs TARGET=browser or TARGET=node (etc.) for us to use
    echo "Building..."
    BUILD_OUTPUT=$(npm run build 2>&1) || { echo "$BUILD_OUTPUT"; exit 1; }
    echo "$BUILD_OUTPUT"

    # Extract target from build output
    TARGET=$(echo "$BUILD_OUTPUT" | grep "Target:" | sed 's/.*Target:[[:space:]]*//')
    RUNTIME=$(echo "$BUILD_OUTPUT" | grep "Runtime:" | sed 's/.*Runtime:[[:space:]]*//' || echo "")

    echo ""
    case "$TARGET" in
      browser)
        echo "Starting browser dev server on $HOST:$PORT..."
        exec npx serve -p "$PORT"
        ;;
      server)
        echo "Starting $RUNTIME server on $HOST:$PORT..."
        case "$RUNTIME" in
          node)
            exec node server.mjs
            ;;
          bun)
            exec bun server.mjs
            ;;
          deno)
            exec deno run --allow-all server.mjs
            ;;
        esac
        ;;
      *)
        echo "Error: Unknown target '$TARGET'"
        exit 1
        ;;
    esac
    ;;

  build)
    echo "Building static assets..."
    exec npm run build
    ;;

  ""|help|-h|--help)
    usage
    ;;

  *)
    echo "Unknown command: $COMMAND"
    echo ""
    usage
    exit 1
    ;;
esac
