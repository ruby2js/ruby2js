# Self-Hosted Ruby2JS Demo

This directory contains a proof-of-concept demonstrating Ruby2JS running entirely in the browser, using the actual Ruby2JS converter transpiled to JavaScript.

## Architecture

```
Ruby Source Code
       ↓
@ruby/prism (WebAssembly, ~2.7MB)
       ↓
Prism AST (JavaScript objects)
       ↓
PrismWalker (transpiled from Ruby)
       ↓
Parser-compatible AST
       ↓
Converter (transpiled from Ruby2JS source)
       ↓
JavaScript Output
```

## Key Files

| File | Description |
|------|-------------|
| `ruby2js` | Node.js CLI for converting Ruby to JavaScript |
| `browser_demo.html` | Interactive browser demo (open via HTTP server) |
| `selfhost_converter.mjs` | The Ruby2JS converter transpiled to JavaScript (~7000 lines) |
| `transpiled_walker.mjs` | PrismWalker: translates Prism AST to Parser-compatible AST |
| `transpile_walker.rb` | Ruby script that generates `transpiled_walker.mjs` |
| `test_e2e.mjs` | End-to-end tests for the self-hosted converter |

## Command Line Usage

The self-hosted Ruby2JS can be run from the command line using Node.js:

```bash
cd demo/selfhost
npm install  # Install @ruby/prism dependency

# Convert a file
node ruby2js script.rb

# Convert from stdin
echo 'x = 42' | node ruby2js

# Compact output (no newlines)
node ruby2js --compact script.rb

# Show help
node ruby2js --help
```

## Running the Browser Demo

The demo requires HTTP (not `file://`) due to ES module and WASM restrictions:

```bash
cd demo/selfhost
python3 -m http.server 8080
# Open http://localhost:8080/browser_demo.html
```

## Regenerating the Self-Hosted Converter

The converter is generated by transpiling the actual Ruby2JS converter source:

```bash
# From the ruby2js root directory
bundle exec ruby lib/ruby2js/selfhost.rb --esm > demo/selfhost/selfhost_converter.mjs
```

This uses the `selfhost` filter to transpile the Ruby2JS converter handlers to JavaScript.

## Regenerating the Walker

```bash
cd demo/selfhost
ruby transpile_walker.rb > transpiled_walker.mjs
```

## Running Tests

```bash
cd demo/selfhost
node test_e2e.mjs  # Tests basic AST node types
```

## What Works

The self-hosted converter supports:

- **Literals**: integers, floats, strings, symbols, nil, true, false
- **Variables**: local (`x`), instance (`@x`), assignments
- **Collections**: arrays, hashes
- **Control flow**: `if/else/elsif`, `case/when`
- **Definitions**: `def foo(args)` → `function foo(args)`
- **Operators**: arithmetic, comparison, logical
- **Begin blocks**: multiple statements

## Current Limitations

- No implicit `return` for method bodies (use explicit `return`)
- Comments are not preserved
- No indentation in output
- Classes and modules not yet tested
- Some complex patterns may not work

## The Selfhost Filter

The `lib/ruby2js/filter/selfhost.rb` filter enables transpiling Ruby2JS internals:

- `s(:type, ...)` → `s('type', ...)` (symbols to strings for AST types)
- `node.type == :sym` → `node.type === 'string'` (type comparisons)
- `class Foo < Prism::Visitor` → class with self-dispatch `visit()` method
- `visit_integer_node` → `visitIntegerNode` (camelCase for JS Prism API)
- `@sep`, `@nl`, `@ws` → `this._sep`, etc. (Serializer base class properties)
- `handle :type do ... end` → `on_type(...)` method definitions

## Size Comparison

| Approach | Size | Notes |
|----------|------|-------|
| Self-hosted | ~2.9MB | prism.wasm + WASI shim + walker + converter |
| Opal-based | ~24MB | Opal runtime + parser gem + Ruby2JS |

## How It Works

1. **Prism WASM** parses Ruby source into a Prism AST
2. **PrismWalker** translates Prism AST nodes to Parser-gem compatible AST format
3. **Converter** (transpiled from Ruby2JS) converts the AST to JavaScript
4. **Serializer** handles output formatting (separators, newlines)

The converter is the actual Ruby2JS converter code, transpiled to JavaScript using Ruby2JS itself with the `selfhost` filter. This means the same conversion logic runs in both Ruby and JavaScript environments.

## Maintenance Overview

Once self-hosting is complete, here's what needs to be maintained:

### Hand-Written Files (~1,150 lines total)

| File | Lines | Purpose |
|------|-------|---------|
| `lib/ruby2js/filter/selfhost.rb` | ~950 | AST transformations for Ruby→JS patterns |
| `preamble.mjs` | ~60 | JS stubs (Node, s(), Hash, NotImplementedError) |
| Build script (Rakefile task) | ~50 | Lists files, calls Ruby2JS.convert, concatenates |
| `browser_demo.html` | ~100 | Demo UI |

### Generated Files (regenerated on build, not manually maintained)

| File | Lines | Source |
|------|-------|--------|
| `transpiled_walker.mjs` | ~1,700 | From `lib/ruby2js/prism_walker.rb` + submodules |
| `transpiled_converter.mjs` | ~6,500 | From `lib/ruby2js/converter.rb` + handlers + serializer |

The `selfhost.rb` filter encodes "how to transpile Ruby2JS's Ruby idioms to JavaScript."
Once it handles all the patterns, changes to the converter/walker Ruby code automatically
flow through to the browser version on rebuild.

## Next Steps

See `plans/SELF_HOSTING.md` for the full roadmap:

- Add implicit return handling for method bodies
- Preserve comments from source
- Add indentation support
- Transpile more filters (functions, esm, camelCase)
- Replace the ruby2js.com demo with the self-hosted version
