# Selfhost Rake tasks
# These build and test the self-hosted Ruby2JS converter

require 'json'
require 'fileutils'

ROOT = File.expand_path('../..', __dir__)
SELFHOST = __dir__
DIST = File.join(SELFHOST, 'dist')

# Helper to run bundle exec from root directory (where Gemfile is)
def bundle_exec(cmd)
  "cd #{ROOT} && BUNDLE_GEMFILE=#{ROOT}/Gemfile bundle exec #{cmd}"
end

# Load manifest
def manifest
  @manifest ||= JSON.parse(File.read(File.join(SELFHOST, 'spec_manifest.json')))
end

directory DIST

# Walker dependencies
walker_deps = FileList["#{ROOT}/lib/ruby2js/node.rb", "#{ROOT}/lib/ruby2js/prism_walker.rb", "#{ROOT}/lib/ruby2js/prism_walker/*.rb"]

# Converter dependencies
converter_deps = FileList["#{ROOT}/lib/ruby2js/converter.rb", "#{ROOT}/lib/ruby2js/converter/*.rb", "#{ROOT}/lib/ruby2js/serializer.rb"]

# Selfhost filter dependencies
selfhost_deps = FileList["#{ROOT}/lib/ruby2js/filter/selfhost.rb", "#{ROOT}/lib/ruby2js/filter/selfhost/*.rb"]

# Namespace dependencies
namespace_deps = FileList["#{ROOT}/lib/ruby2js/namespace.rb"]

# Runtime dependencies
runtime_deps = FileList["#{ROOT}/lib/ruby2js/selfhost/runtime.rb"]

# Prism browser dependencies
prism_browser_deps = FileList["#{ROOT}/lib/ruby2js/selfhost/prism_browser.rb"]

# Bundle dependencies (includes CLI)
bundle_deps = FileList["#{ROOT}/lib/ruby2js/selfhost/bundle.rb", "#{ROOT}/lib/ruby2js/selfhost/cli.rb"]

# ERB Compiler dependencies
erb_compiler_deps = FileList["#{ROOT}/lib/ruby2js/rails/erb_compiler.rb"]
migration_sql_deps = FileList["#{ROOT}/lib/ruby2js/rails/migration_sql.rb"]
seed_sql_deps = FileList["#{ROOT}/lib/ruby2js/rails/seed_sql.rb"]

desc "Build prism_browser.js (in selfhost root for correct node_modules paths)"
file "#{SELFHOST}/prism_browser.js" => [*prism_browser_deps, *selfhost_deps] do
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_prism_browser.rb > #{SELFHOST}/prism_browser.js")
end

desc "Build ruby2js.js (library for CLI, browser, and tests)"
file "#{SELFHOST}/ruby2js.js" => [*bundle_deps, *runtime_deps, *namespace_deps, *walker_deps, *converter_deps, *selfhost_deps] do
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_bundle.rb > #{SELFHOST}/ruby2js.js")
end

desc "Build erb_compiler.js (ERB to Ruby compiler)"
file "#{SELFHOST}/lib/erb_compiler.js" => [*erb_compiler_deps] do
  FileUtils.mkdir_p("#{SELFHOST}/lib")
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_erb_compiler.rb > #{SELFHOST}/lib/erb_compiler.js")
end

desc "Build migration_sql.js (SQL generator for D1 migrations)"
file "#{SELFHOST}/lib/migration_sql.js" => [*migration_sql_deps] do
  FileUtils.mkdir_p("#{SELFHOST}/lib")
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_migration_sql.rb > #{SELFHOST}/lib/migration_sql.js")
end

desc "Build seed_sql.js (SQL generator for D1 seeds)"
file "#{SELFHOST}/lib/seed_sql.js" => [*seed_sql_deps] do
  FileUtils.mkdir_p("#{SELFHOST}/lib")
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_seed_sql.rb > #{SELFHOST}/lib/seed_sql.js")
end

# Map spec names to filter names (when they differ)
SPEC_TO_FILTER = {
  'camelcase_spec.rb' => 'camelCase',
  'cjs_spec.rb' => 'cjs',
  'rails_logger_spec.rb' => 'rails/logger',
  'rails_model_spec.rb' => 'rails/model',
  'rails_controller_spec.rb' => 'rails/controller',
  'rails_routes_spec.rb' => 'rails/routes',
  'rails_migration_spec.rb' => 'rails/migration',
  'rails_seeds_spec.rb' => 'rails/seeds'
}

# Derive filter name from spec name
def filter_for_spec(spec_name)
  SPEC_TO_FILTER[spec_name] || spec_name.sub('_spec.rb', '')
end

# Get filters needed for ready + partial specs (only those with actual filter files)
def manifest_filters
  specs = manifest['ready'] + manifest['partial'].map { |e| e.is_a?(Hash) ? e['spec'] : e }
  specs.map { |s| filter_for_spec(s) }
       .uniq
       .select { |name| File.exist?("#{ROOT}/lib/ruby2js/filter/#{name}.rb") }
end

# Filter output files for manifest specs
filters_dir = "#{SELFHOST}/filters"
FILTER_TARGETS = manifest_filters.map { |name| "#{filters_dir}/#{name}.js" }

desc "Build lib files (erb_compiler, migration_sql, seed_sql)"
task :build_lib => ["#{SELFHOST}/lib/erb_compiler.js", "#{SELFHOST}/lib/migration_sql.js", "#{SELFHOST}/lib/seed_sql.js"]

desc "Build manifest filters (batch)"
task :build_filters => ["#{SELFHOST}/ruby2js.js"] do
  puts "Building filters..."
  sh bundle_exec("ruby #{SELFHOST}/scripts/build_all.rb filters")
end

# Core build targets (library and prism_browser)
CORE_TARGETS = ["#{SELFHOST}/ruby2js.js", "#{SELFHOST}/prism_browser.js"]

desc "Build all transpiled files (bundle, prism_browser, specs, filters)"
task :build => [*CORE_TARGETS, :build_filters] do
  puts "Building specs..."
  sh bundle_exec("ruby #{SELFHOST}/scripts/build_all.rb specs")
end

desc "Build only ready specs"
task :build_ready => [*CORE_TARGETS, :build_filters] do
  puts "Building ready specs..."
  sh bundle_exec("ruby #{SELFHOST}/scripts/build_all.rb ready")
end

desc "Build partial specs"
task :build_partial => [*CORE_TARGETS, :build_filters] do
  puts "Building partial specs..."
  sh bundle_exec("ruby #{SELFHOST}/scripts/build_all.rb partial")
end

desc "Install npm dependencies"
task :npm_install do
  Dir.chdir(SELFHOST) do
    sh "npm install" unless File.exist?('node_modules/@ruby/prism')
  end
end

desc "Run walker unit tests"
task :test_walker => [:npm_install, "#{SELFHOST}/ruby2js.js"] do
  Dir.chdir(SELFHOST) do
    sh "node test_walker.mjs"
  end
end

desc "Run spec tests (requires build first)"
task :test_specs => :npm_install do
  Dir.chdir(SELFHOST) do
    sh "node run_all_specs.mjs --skip-transpile"
  end
end

desc "Run only ready spec tests"
task :test_ready => :npm_install do
  Dir.chdir(SELFHOST) do
    sh "node run_all_specs.mjs --skip-transpile --ready-only"
  end
end

desc "Run partial spec tests (informational, won't fail)"
task :test_partial => :npm_install do
  Dir.chdir(SELFHOST) do
    # Run partial specs but don't fail CI - they're informational
    sh "node run_all_specs.mjs --skip-transpile --partial-only || true"
  end
end

PACKAGE = File.join(ROOT, 'packages/ruby2js-rails')
BUILD_MJS = File.join(PACKAGE, 'build.mjs')

desc "Install npm dependencies for ruby2js-rails package"
task :npm_install_package do
  Dir.chdir(PACKAGE) do
    sh "npm install" unless File.exist?('node_modules/js-yaml')
  end
end

desc "Transpile builder.rb to build.mjs for selfhost builds"
file BUILD_MJS => ["#{ROOT}/lib/ruby2js/rails/builder.rb", "#{ROOT}/lib/ruby2js/filter/selfhost_build.rb"] do
  # Use stdin instead of file argument to work around autoexports + file read issue
  # Note: node and functions filters must run before esm so require removals happen before esm transforms requireâ†’import
  sh bundle_exec("cat #{ROOT}/lib/ruby2js/rails/builder.rb | ruby #{ROOT}/bin/ruby2js --filter selfhost_build --filter node --filter functions --filter esm --filter return --filter pragma --autoexports > #{BUILD_MJS}")
  # Add shebang and fix relative paths for new location (packages/ruby2js-rails/)
  # Source is now lib/ruby2js/rails/builder.rb, output is packages/ruby2js-rails/build.mjs
  content = "#!/usr/bin/env node\n" + File.read(BUILD_MJS)
  content = content.gsub('../../../selfhost/', '../../demo/selfhost/')
  content = content.gsub('./erb_compiler', '../../demo/selfhost/lib/erb_compiler.js')
  File.write(BUILD_MJS, content)
end

desc "Force rebuild of build.mjs (development version with relative paths)"
task :build_mjs do
  rm_f BUILD_MJS
  Rake::Task[BUILD_MJS].invoke
  puts "Built: #{BUILD_MJS}"
end

desc "Build build.mjs with npm package imports (for ruby2js-rails package)"
task "build_mjs:npm" => :build_mjs do
  content = File.read(BUILD_MJS)
  # Convert relative paths to npm package imports
  # After build_mjs, paths are ../../demo/selfhost/... - convert to ruby2js package
  content = content.gsub('../../demo/selfhost/ruby2js.js', 'ruby2js')
  content = content.gsub('../../demo/selfhost/filters/', 'ruby2js/filters/')
  # Rails-specific lib files (erb_compiler, migration_sql, seed_sql) stay in ruby2js-rails
  content = content.gsub('../../demo/selfhost/lib/', './lib/')
  File.write(BUILD_MJS, content)
  puts "Converted to npm package imports: #{BUILD_MJS}"

  # Build Rails-specific lib files into ruby2js-rails package
  lib_dir = File.join(PACKAGE, 'lib')
  FileUtils.mkdir_p(lib_dir)
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_erb_compiler.rb > #{lib_dir}/erb_compiler.js")
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_migration_sql.rb > #{lib_dir}/migration_sql.js")
  sh bundle_exec("ruby #{SELFHOST}/scripts/transpile_seed_sql.rb > #{lib_dir}/seed_sql.js")
  puts "Built lib files in #{lib_dir}"
end

desc "Build and run all tests"
task :test => [:build, :test_walker, :test_specs]

desc "Build and run CI tests (ready must pass, partial informational)"
task :ci => [:build_ready, :build_partial, :test_walker, :test_ready, :test_partial]

desc "Clean dist directory and generated files"
task :clean do
  rm_rf DIST
  rm_rf "#{SELFHOST}/filters"
  rm_rf "#{SELFHOST}/lib"
  rm_f "#{SELFHOST}/ruby2js.js"
  rm_f "#{SELFHOST}/prism_browser.js"
  rm_f BUILD_MJS
end

task :default => :test
