# Convenience file, allowing Rake to be run from this directory

BLOG_DIR = File.join(__dir__, 'blog')

desc "Create local blog demo for testing"
task :blog do
  if File.directory?(BLOG_DIR)
    puts "demo/blog already exists. Run 'rake blog_clean' first to remove it."
  else
    Dir.chdir __dir__ do
      # Run outside bundle context since create-blog needs Rails
      Bundler.with_unbundled_env do
        sh "../test/blog/create-blog"
      end
    end

    # Patch Gemfile to use local gem instead of GitHub
    gemfile = File.join(BLOG_DIR, 'Gemfile')
    content = File.read(gemfile)
    content.gsub!(/gem "ruby2js".*github.*$/, 'gem "ruby2js", path: "../.."')
    File.write(gemfile, content)

    # Re-run bundle install with patched Gemfile
    Dir.chdir BLOG_DIR do
      Bundler.with_unbundled_env do
        sh "bundle install"
      end
    end

    # Remove auto-generated package.json so dev regenerates it with local paths
    package_json = File.join(BLOG_DIR, 'package.json')
    rm_f package_json if File.exist?(package_json)

    # Patch Tailwind CSS to use standard directives (Rails gem uses @import "tailwindcss")
    tailwind_css = File.join(BLOG_DIR, 'app/assets/tailwind/application.css')
    if File.exist?(tailwind_css)
      File.write(tailwind_css, <<~CSS)
        @tailwind base;
        @tailwind components;
        @tailwind utilities;
      CSS

      # Create tailwind.config.js for npm tailwindcss CLI
      File.write(File.join(BLOG_DIR, 'tailwind.config.js'), <<~JS)
        /** @type {import('tailwindcss').Config} */
        module.exports = {
          content: [
            './app/views/**/*.{erb,html}',
            './dist/views/**/*.html'
          ],
          theme: {
            extend: {},
          },
          plugins: [],
        }
      JS
    end

    puts "\nCreated demo/blog with local gem. You can now:"
    puts "  cd blog"
    puts "  bundle exec ruby2js dev"
  end
end

desc "Remove local blog demo"
task :blog_clean do
  if File.directory?(BLOG_DIR)
    rm_rf BLOG_DIR
    puts "Removed demo/blog"
  else
    puts "demo/blog does not exist"
  end
end

task :watch do
  Dir.chdir __dir__ do
    sh 'ls *.opal livedemo.js.rb ruby2js.rb controllers/*_controller.js.rb nodetest.js | entr rake test'
  end
end

task :test => :default do
  Dir.chdir __dir__ do
    sh "node nodetest.js"
  end
end

# pass NODE_ENV=development to disable 'terse'
ENV['NODE_ENV'] = 'development'
Dir.chdir File.expand_path('../docs', __dir__)
load 'Rakefile'
