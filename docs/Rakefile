begin
  require "bridgetown"

  Bridgetown.load_tasks
rescue LoadError => e
  puts "Warning: Bridgetown gem not available in this environment. (OK when compiling JS packages)"
end

#
# Standard set of tasks, which you can customize if you wish:
#
desc "Build the Bridgetown site for deployment"
#task :deploy => [:bt_clean, :clean, "frontend:build", :default] do
task :deploy => [:bt_clean, "frontend:build"] do
  Bridgetown::Commands::Build.start
end

desc "Build the site in a test environment"
task :test do
  ENV["BRIDGETOWN_ENV"] = "test"
  Bridgetown::Commands::Build.start
end

desc "Runs the clean command"
task :bt_clean do
  Bridgetown::Commands::Clean.start
end

namespace :frontend do
  desc "Build the frontend with esbuild for deployment"
  task :build do
    sh "yarn run esbuild"
  end

  desc "Watch the frontend with esbuild during development"
  task :dev do
    sh "yarn run esbuild-dev"
  rescue Interrupt
  end
end

####

docs = File.expand_path(__dir__)
dest = "#{docs}/src/demo"
root = File.expand_path('..', docs)
demo = "#{root}/demo"
source_files = Rake::FileList.new("#{root}/lib/**/*.rb", "#{root}/lib/ruby2js.rb")
filters = Rake::FileList.new("#{root}/lib/ruby2js/filter/*.rb")
opal_files = Rake::FileList.new("#{root}/demo/*.opal")
controller_files = Rake::FileList.new("#{root}/demo/controllers/*_controller.js.rb")

require 'bundler/setup'
require 'regexp_parser'
regexp_parser_path = File.dirname(Gem.find_files_from_load_path('regexp_parser').first)

terser = "npx terser --compress --mangle"
terser = "cat" if ENV['NODE_ENV'] == 'development'

file "#{root}/demo/filters.opal" => filters do
  puts 'generate filters.opal'
  content = filters.map do |file|
    next if File.basename(file) == 'lit-element.rb'
    require file
    "require #{"ruby2js/filter/#{File.basename(file, '.rb')}".inspect}"
  end

  # find each module and add it to the list of filters.
  filters = {}
  Ruby2JS::Filter::DEFAULTS.each do |mod|
    method = mod.instance_method(mod.instance_methods.first)
    name = method.source_location.first
    filters[File.basename(name, '.rb')] = mod
  end
  content << "Ruby2JS::Filter.registered_filters.merge!(#{filters.inspect})"

  IO.write "#{root}/demo/filters.opal", content.compact.join("\n")
end

file "#{dest}/index.erb" => [*filters, "#{root}/demo/views/demo.erb"] do
  puts "Generating #{dest}/index.erb"
  mkdir dest unless Dir.exist? dest

  require 'erb'
  require 'ruby2js/demo'

  # Set up template variables for live mode (Shoelace/Bridgetown)
  # Uses shared configuration from Ruby2JS::Demo
  @live = true
  @ruby = Ruby2JS::Demo.default_ruby
  @eslevel = nil
  @ast = false
  @preset = true
  @filter_list = Ruby2JS::Demo.available_filters
  @eslevel_list = Ruby2JS::Demo.available_eslevels
  @option_list = Ruby2JS::Demo.available_options
  @selected = []
  @options_checked = {}
  @js_output = nil
  @parsed_html = nil
  @filtered_html = nil
  @error = nil

  # Render the shared ERB template
  template_path = "#{root}/demo/views/demo.erb"
  template = ERB.new(File.read(template_path), trim_mode: '-')
  body = template.result(binding)

  # Add link to self-hosted demo at the bottom
  selfhost_link = <<~HTML
    <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
      <a href="/demo/selfhost" style="color: #0d6efd;">
        Try the Self-Hosted Preview &rarr;
      </a>
      <span style="color: #666; font-size: 0.85em; margin-left: 0.5rem;">
        (experimental)
      </span>
    </div>
  HTML

  erb_output = [
    "---\nlayout: default\n---\n",
    body,
    selfhost_link
  ].join("\n")

  IO.write("#{dest}/index.erb", erb_output)
end

file "#{dest}/editor.js" => ["#{root}/demo/editor.js"] do
  sh "cat #{root}/demo/editor.js | " +
    "npx rollup -f iife -p @rollup/plugin-node-resolve |" +
    "#{terser} > src/demo/editor.js"
end

file "#{dest}/litelement.js" => ["#{root}/demo/litelement.js"] do
  sh "cat #{root}/demo/litelement.js | " +
    "npx rollup -f iife -p @rollup/plugin-node-resolve |" +
    "#{terser} > src/demo/litelement.js"
end

file "#{dest}/livedemo.js" => ["#{root}/demo/livedemo.js.rb", *controller_files] do
  sh "#{RbConfig.ruby} #{root}/demo/ruby2js.rb --filter esm --filter require --filter stimulus --filter functions --identity --es2020 #{root}/demo/livedemo.js.rb | " +
    "npx rollup -f iife --context window -p @rollup/plugin-node-resolve | " +
    "#{terser} > #{dest}/livedemo.js"
end

deps = [*opal_files, *source_files, "#{root}/demo/filters.opal"]
opal = "opal --compile -E -I #{regexp_parser_path} -I #{root}/lib -I #{demo} #{demo}/ruby2js.opal"

file "#{dest}/ruby2js.js" => deps do
  mkdir dest unless Dir.exist? dest
  Dir.chdir dest do
    sh "#{opal} | #{terser} > #{dest}/ruby2js.js"
  end
end

file "ruby2js.js" => deps do
  target = File.expand_path('ruby2js.js')
  Dir.chdir docs do
    sh "#{opal} | #{terser} > #{target}"
  end
end

task :clean do
  rm_rf "#{docs}/src/demo"
end

task :clobber => :clean do
  rm_rf "#{root}/demo/selfhost/dist"
end

desc "Install all dependencies (Ruby gems, Node packages, selfhost)"
task :install do
  sh "bundle install"
  sh "yarn install"
  Dir.chdir("#{root}/demo/selfhost") do
    sh "npm install"
  end
end

# Selfhost demo - delegates to demo/selfhost/Rakefile for building,
# then copies files to docs site
selfhost_dir = "#{dest}/selfhost"
selfhost_source = "#{root}/demo/selfhost"
selfhost_rakefile = "#{selfhost_source}/Rakefile"

directory dest
directory selfhost_dir => dest

# Build selfhost bundle using the authoritative Rakefile
# This ensures dependency tracking is in one place
task :selfhost_build do
  Dir.chdir(selfhost_source) do
    # Build core files, filters, erb_compiler, and build.mjs needed for the demo
    sh "bundle exec rake #{selfhost_source}/ruby2js.js #{selfhost_source}/prism_browser.js #{selfhost_source}/lib/erb_compiler.js build_filters build_mjs:npm"
  end
end

# Install selfhost npm dependencies if needed (provides @ruby/prism)
selfhost_prism_source = "#{selfhost_source}/node_modules/@ruby/prism"
task :selfhost_npm_install do
  unless File.exist?(selfhost_prism_source)
    Dir.chdir(selfhost_source) do
      sh "npm install"
    end
  end
end

# Copy @ruby/prism module (needed for browser to load WASM)
prism_dir = "#{selfhost_dir}/node_modules/@ruby/prism"
directory "#{selfhost_dir}/node_modules/@ruby" => selfhost_dir

task :selfhost_copy_prism => ["#{selfhost_dir}/node_modules/@ruby", :selfhost_npm_install] do
  cp_r selfhost_prism_source, prism_dir unless File.exist?(prism_dir)
end

# Copy browser-compatible Prism loader
task :selfhost_copy_prism_browser => [selfhost_dir, :selfhost_build] do
  cp "#{selfhost_source}/prism_browser.js", "#{selfhost_dir}/prism_browser.js"
end

# Copy the library bundle
task :selfhost_copy_bundle => [selfhost_dir, :selfhost_build] do
  cp "#{selfhost_source}/ruby2js.js", "#{selfhost_dir}/ruby2js.js"
end

# Copy filters directory - all filters needed for combo boxes
task :selfhost_copy_filters => [selfhost_dir, :selfhost_build] do
  filters_dir = "#{selfhost_dir}/filters"
  rails_dir = "#{filters_dir}/rails"
  mkdir_p filters_dir unless File.exist?(filters_dir)
  mkdir_p rails_dir unless File.exist?(rails_dir)

  # Core filters used by most combo boxes
  %w[functions esm pragma return camelCase active_support polyfill erb].each do |filter|
    src = "#{selfhost_source}/filters/#{filter}.js"
    cp src, "#{filters_dir}/#{filter}.js" if File.exist?(src)
  end

  # Rails filters
  %w[model controller routes schema seeds logger].each do |filter|
    src = "#{selfhost_source}/filters/rails/#{filter}.js"
    cp src, "#{rails_dir}/#{filter}.js" if File.exist?(src)
  end
end

# Copy lib directory (erb_compiler.js, etc.)
task :selfhost_copy_lib => [selfhost_dir, :selfhost_build] do
  lib_dir = "#{selfhost_dir}/lib"
  mkdir_p lib_dir unless File.exist?(lib_dir)

  %w[erb_compiler.js].each do |file|
    src = "#{selfhost_source}/lib/#{file}"
    cp src, "#{lib_dir}/#{file}" if File.exist?(src)
  end
end

# Note: index.html is checked into docs/src/demo/selfhost/ directly

task :selfhost => [
  :selfhost_copy_prism_browser,
  :selfhost_copy_bundle,
  :selfhost_copy_filters,
  :selfhost_copy_lib,
  :selfhost_copy_prism
] do
  # Ensure all files are world-readable (needed for nginx in Docker)
  FileUtils.chmod_R(0644, Dir.glob("#{selfhost_dir}/**/*.js"))
  FileUtils.chmod_R(0644, Dir.glob("#{selfhost_dir}/**/*.wasm"))
end

# Ruby2JS-on-Rails demo - build and deploy the Rails-like blog demo
# The demo runs entirely in JavaScript, transpiled from Ruby source files
rails_demo_source = "#{root}/demo/ruby2js-on-rails"
rails_demo_dest = "#{dest}/ruby2js-on-rails"

directory rails_demo_dest => dest

# Install npm dependencies for the Rails demo
task :rails_demo_npm_install do
  unless File.exist?("#{rails_demo_source}/node_modules")
    Dir.chdir(rails_demo_source) do
      sh "npm install"
    end
  end
end

# Build the demo using Ruby2JS
# This transpiles all Ruby files to JavaScript in dist/
# Uses Ruby gem directly (faster, and smoke test validates identical output to selfhost)
task :rails_demo_build => [:rails_demo_npm_install] do
  Dir.chdir(rails_demo_source) do
    sh "bundle exec ruby -r ruby2js/rails/builder -e 'SelfhostBuilder.new.build'"
  end
end

# Copy built files to docs site
task :rails_demo_copy => [rails_demo_dest, :rails_demo_build] do
  # Copy transpiled JavaScript
  cp_r "#{rails_demo_source}/dist", "#{rails_demo_dest}/dist"
  puts "  dist/"

  # Copy public assets
  cp_r "#{rails_demo_source}/public", "#{rails_demo_dest}/public"
  puts "  public/"

  # Copy sql.js (needed for WASM)
  sqljs_dest = "#{rails_demo_dest}/node_modules/sql.js"
  mkdir_p sqljs_dest
  cp_r "#{rails_demo_source}/node_modules/sql.js/dist", "#{sqljs_dest}/dist"
  # Fix permissions on copied directory
  chmod_R 0755, "#{sqljs_dest}/dist"
  puts "  node_modules/sql.js/"

  # Copy dexie (for import map)
  dexie_dest = "#{rails_demo_dest}/node_modules/dexie"
  mkdir_p dexie_dest
  cp_r "#{rails_demo_source}/node_modules/dexie/dist", "#{dexie_dest}/dist"
  puts "  node_modules/dexie/"
end

# Create downloadable tarball
# build.mjs now lives in packages/ruby2js-rails/ (no longer generated from build.rb)
task :rails_demo_tarball => [:selfhost_build] do
  # Run publish script to create the tarball
  Dir.chdir(selfhost_source) do
    sh "bundle exec ruby scripts/publish_demo.rb"
  end

  # Copy tarball to docs output (will be at /demo/ruby2js-on-rails.tar.gz)
  tarball_src = "#{selfhost_source}/dist/ruby2js-on-rails.tar.gz"
  tarball_dest = "#{dest}/ruby2js-on-rails.tar.gz"
  cp tarball_src, tarball_dest
  puts "  ruby2js-on-rails.tar.gz (#{(File.size(tarball_dest) / 1024.0).round(1)} KB)"
end

# Note: index.html is checked into docs/src/demo/ruby2js-on-rails/ directly

task :rails_demo => [:rails_demo_copy, :rails_demo_tarball] do
  # Ensure all files are world-readable (excluding node_modules which has its own permissions)
  Dir.glob("#{rails_demo_dest}/**/*.js").reject { |f| f.include?('/node_modules/') }.each { |f| FileUtils.chmod(0644, f) }
  Dir.glob("#{rails_demo_dest}/**/*.mjs").reject { |f| f.include?('/node_modules/') }.each { |f| FileUtils.chmod(0644, f) }
  Dir.glob("#{rails_demo_dest}/**/*.css").reject { |f| f.include?('/node_modules/') }.each { |f| FileUtils.chmod(0644, f) }
  Dir.glob("#{rails_demo_dest}/**/*.wasm").reject { |f| f.include?('/node_modules/') }.each { |f| FileUtils.chmod(0644, f) }
  puts "Rails demo ready at /demo/ruby2js-on-rails/"
end

desc "Build livedemo.js (for CI smoke test)"
task :livedemo => "#{dest}/livedemo.js"

desc "Test that the Opal-compiled Ruby2JS converts code correctly"
task :test_demo => ["#{dest}/ruby2js.js"] do
  # Use the Ruby gem directly to test preset conversion
  # This validates that the same logic that built the demo works correctly
  require 'ruby2js'
  require 'ruby2js/filter/functions'
  require 'ruby2js/filter/esm'
  require 'ruby2js/filter/return'

  # Test 1: Basic conversion with preset (puts -> console.log)
  result1 = Ruby2JS.convert('puts "hello"', preset: true).to_s
  unless result1.include?('console.log')
    raise "FAIL: preset conversion of puts - expected console.log, got: #{result1}"
  end

  # Test 2: Verify functions filter is applied (upcase -> toUpperCase)
  result2 = Ruby2JS.convert('"hello".upcase', preset: true).to_s
  unless result2.include?('toUpperCase')
    raise "FAIL: preset conversion of upcase - expected toUpperCase, got: #{result2}"
  end

  puts "Demo smoke test passed: preset conversion works correctly"
end

# NPM package tarballs for beta distribution
# These go to /releases/ on the website for URL-based npm install
releases_dir = "#{docs}/src/releases"
directory releases_dir

# Build ruby2js npm package tarball
task :ruby2js_tarball => [:selfhost_build, releases_dir] do
  Dir.chdir(selfhost_source) do
    # Clean up old tarballs
    FileUtils.rm_f Dir.glob("ruby2js-*.tgz")

    # Set timestamped version for npm update detection
    version = "6.0.0-beta.#{Time.now.strftime('%Y%m%d%H%M')}"
    sh "npm version #{version} --no-git-tag-version --allow-same-version"

    # Pack only (build already done by :selfhost_build dependency)
    sh "npm run pack:only"

    # Copy to releases with stable name
    tarball = Dir.glob("ruby2js-*.tgz").first
    cp tarball, "#{releases_dir}/ruby2js-beta.tgz"
    puts "  ruby2js-beta.tgz (#{(File.size("#{releases_dir}/ruby2js-beta.tgz") / 1024.0).round(1)} KB)"

    # Reset version for git
    sh "npm version 6.0.0-beta --no-git-tag-version --allow-same-version"
  end
end

# Build ruby2js-rails npm package tarball
# Package now lives at packages/ruby2js-rails/
# Depends on selfhost_build to generate build.mjs with npm package imports
task :ruby2js_rails_tarball => [:ruby2js_tarball, :selfhost_build] do
  rails_pkg_dir = "#{root}/packages/ruby2js-rails"
  Dir.chdir(rails_pkg_dir) do
    # Clean up old tarballs
    FileUtils.rm_f Dir.glob("ruby2js-rails-*.tgz")

    # Set timestamped version
    version = "6.0.0-beta.#{Time.now.strftime('%Y%m%d%H%M')}"
    sh "npm version #{version} --no-git-tag-version --allow-same-version"

    # Add ruby2js dependency for the published package
    sh "npm pkg set dependencies.ruby2js=https://www.ruby2js.com/releases/ruby2js-beta.tgz"

    # Pack
    sh "npm pack"

    # Remove dependency (keep source clean for development)
    sh "npm pkg delete dependencies.ruby2js"

    # Copy to releases with stable name
    tarball = Dir.glob("ruby2js-rails-*.tgz").first
    cp tarball, "#{releases_dir}/ruby2js-rails-beta.tgz"
    puts "  ruby2js-rails-beta.tgz (#{(File.size("#{releases_dir}/ruby2js-rails-beta.tgz") / 1024.0).round(1)} KB)"

    # Reset version for git
    sh "npm version 6.0.0-beta --no-git-tag-version --allow-same-version"
  end
end

desc "Build npm package tarballs for beta distribution"
task :npm_packages => [:ruby2js_tarball, :ruby2js_rails_tarball]

task :default => [
  "#{dest}/index.erb",
  "#{dest}/editor.js",
  "#{dest}/litelement.js",
  "#{dest}/livedemo.js",
  "#{dest}/ruby2js.js",
  :selfhost,
  :rails_demo,
  :npm_packages,
  :test_demo
]

