begin
  require "bridgetown"

  Bridgetown.load_tasks
rescue LoadError => e
  puts "Warning: Bridgetown gem not available in this environment. (OK when compiling JS packages)"
end

#
# Standard set of tasks, which you can customize if you wish:
#
desc "Build the Bridgetown site for deployment"
#task :deploy => [:bt_clean, :clean, "frontend:build", :default] do
task :deploy => [:bt_clean, "frontend:build"] do
  Bridgetown::Commands::Build.start
end

desc "Build the site in a test environment"
task :test do
  ENV["BRIDGETOWN_ENV"] = "test"
  Bridgetown::Commands::Build.start
end

desc "Runs the clean command"
task :bt_clean do
  Bridgetown::Commands::Clean.start
end

namespace :frontend do
  desc "Build the frontend with esbuild for deployment"
  task :build do
    sh "yarn run esbuild"
  end

  desc "Watch the frontend with esbuild during development"
  task :dev do
    sh "yarn run esbuild-dev"
  rescue Interrupt
  end
end

####

docs = File.expand_path(__dir__)
dest = "#{docs}/src/demo"
root = File.expand_path('..', docs)
demo = "#{root}/demo"
source_files = Rake::FileList.new("#{root}/lib/**/*.rb", "#{root}/lib/ruby2js.rb")
filters = Rake::FileList.new("#{root}/lib/ruby2js/filter/*.rb")
opal_files = Rake::FileList.new("#{root}/demo/*.opal")
controller_files = Rake::FileList.new("#{root}/demo/controllers/*_controller.js.rb")

require 'bundler/setup'
require 'regexp_parser'
regexp_parser_path = File.dirname(Gem.find_files_from_load_path('regexp_parser').first)

terser = "npx terser --compress --mangle"
terser = "cat" if ENV['NODE_ENV'] == 'development'

file "#{root}/demo/filters.opal" => filters do
  puts 'generate filters.opal'
  content = filters.map do |file|
    next if File.basename(file) == 'lit-element.rb'
    require file
    "require #{"ruby2js/filter/#{File.basename(file, '.rb')}".inspect}"
  end

  # find each module and add it to the list of filters.
  filters = {}
  Ruby2JS::Filter::DEFAULTS.each do |mod|
    method = mod.instance_method(mod.instance_methods.first)
    name = method.source_location.first
    filters[File.basename(name, '.rb')] = mod
  end
  content << "Ruby2JS::Filter.registered_filters.merge!(#{filters.inspect})"

  IO.write "#{root}/demo/filters.opal", content.compact.join("\n")
end

file "#{dest}/index.erb" => [*filters, "#{root}/demo/ruby2js.rb"] do
  puts "Generating #{dest}/index.erb"
  mkdir dest unless Dir.exist? dest

  begin
    request_uri = ENV['REQUEST_URI']
    ENV['REQUEST_URI'] = '/demo'
    livedoc = `#{RbConfig.ruby} #{root}/demo/ruby2js.rb --live`
  ensure
    if request_uri
      ENV['REQUEST_URI'] = request_uri
    else
      ENV.delete 'REQUEST_URI'
    end

    body = livedoc[/<body.*?>(.*?)<\/body>/m, 1].
      sub(/<style.*?<\/style>/m, '').
      sub(/<script.*?<\/script>/m, '')

    # Add link to self-hosted demo at the bottom
    selfhost_link = <<~HTML
      <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <a href="/demo/selfhost" style="color: #0d6efd;">
          Try the Self-Hosted Preview &rarr;
        </a>
        <span style="color: #666; font-size: 0.85em; margin-left: 0.5rem;">
          (experimental)
        </span>
      </div>
    HTML

    erb = [
      "---\nlayout: default\n---\n",
      body,
      selfhost_link
    ].join("\n")

    IO.write("#{dest}/index.erb", erb)
  end
end

file "#{dest}/editor.js" => ["#{root}/demo/editor.js"] do
  sh "cat #{root}/demo/editor.js | " +
    "npx rollup -f iife -p @rollup/plugin-node-resolve |" +
    "#{terser} > src/demo/editor.js"
end

file "#{dest}/litelement.js" => ["#{root}/demo/litelement.js"] do
  sh "cat #{root}/demo/litelement.js | " +
    "npx rollup -f iife -p @rollup/plugin-node-resolve |" +
    "#{terser} > src/demo/litelement.js"
end

file "#{dest}/livedemo.js" => ["#{root}/demo/livedemo.js.rb", *controller_files] do
  sh "#{RbConfig.ruby} #{root}/demo/ruby2js.rb --filter esm --filter require --filter stimulus --filter functions --identity --es2020 #{root}/demo/livedemo.js.rb | " +
    "npx rollup -f iife --context window -p @rollup/plugin-node-resolve | " +
    "#{terser} > #{dest}/livedemo.js"
end

deps = [*opal_files, *source_files, "#{root}/demo/filters.opal"]
opal = "opal --compile -E -I #{regexp_parser_path} -I #{root}/lib -I #{demo} #{demo}/ruby2js.opal"

file "#{dest}/ruby2js.js" => deps do
  mkdir dest unless Dir.exist? dest
  Dir.chdir dest do
    sh "#{opal} | #{terser} > #{dest}/ruby2js.js"
  end
end

file "ruby2js.js" => deps do
  target = File.expand_path('ruby2js.js')
  Dir.chdir docs do
    sh "#{opal} | #{terser} > #{target}"
  end
end

task :clean do
  rm_rf "#{docs}/src/demo"
end

task :clobber => :clean do
  rm_rf "#{root}/demo/selfhost/dist"
end

desc "Install all dependencies (Ruby gems, Node packages, selfhost)"
task :install do
  sh "bundle install"
  sh "yarn install"
  Dir.chdir("#{root}/demo/selfhost") do
    sh "npm install"
  end
end

# Selfhost demo - builds and copies the self-hosted converter demo
selfhost_dir = "#{dest}/selfhost"
selfhost_source = "#{root}/demo/selfhost"
selfhost_dist = "#{selfhost_dir}/dist"

directory dest
directory selfhost_dir => dest
directory selfhost_dist => selfhost_dir

# Build transpiled files in demo/selfhost
selfhost_source_dist = "#{selfhost_source}/dist"
directory selfhost_source_dist

selfhost_walker_deps = Rake::FileList.new("#{root}/lib/ruby2js/node.rb", "#{root}/lib/ruby2js/prism_walker.rb", "#{root}/lib/ruby2js/prism_walker/*.rb")
selfhost_converter_deps = Rake::FileList.new("#{root}/lib/ruby2js/converter.rb", "#{root}/lib/ruby2js/converter/*.rb", "#{root}/lib/ruby2js/serializer.rb")
selfhost_filter_deps = Rake::FileList.new("#{root}/lib/ruby2js/filter/selfhost.rb", "#{root}/lib/ruby2js/filter/selfhost/*.rb")

file "#{selfhost_source}/dist/walker.mjs" => [selfhost_source_dist, *selfhost_walker_deps, *selfhost_filter_deps] do
  Dir.chdir(selfhost_source) do
    sh "npm run build:walker"
  end
end

file "#{selfhost_source}/dist/converter.mjs" => [selfhost_source_dist, *selfhost_converter_deps, *selfhost_filter_deps] do
  Dir.chdir(selfhost_source) do
    sh "npm run build:converter"
  end
end

selfhost_namespace_deps = Rake::FileList.new("#{root}/lib/ruby2js/namespace.rb")

file "#{selfhost_source}/dist/namespace.mjs" => [selfhost_source_dist, *selfhost_namespace_deps, *selfhost_filter_deps] do
  Dir.chdir(selfhost_source) do
    sh "npm run build:namespace"
  end
end

# Copy dist files to docs
file "#{selfhost_dist}/walker.mjs" => [selfhost_dist, "#{selfhost_source}/dist/walker.mjs"] do
  cp "#{selfhost_source}/dist/walker.mjs", "#{selfhost_dist}/walker.mjs"
end

file "#{selfhost_dist}/converter.mjs" => [selfhost_dist, "#{selfhost_source}/dist/converter.mjs"] do
  cp "#{selfhost_source}/dist/converter.mjs", "#{selfhost_dist}/converter.mjs"
end

file "#{selfhost_dist}/namespace.mjs" => [selfhost_dist, "#{selfhost_source}/dist/namespace.mjs"] do
  cp "#{selfhost_source}/dist/namespace.mjs", "#{selfhost_dist}/namespace.mjs"
end

# Runtime dependencies
selfhost_runtime_deps = Rake::FileList.new("#{root}/lib/ruby2js/selfhost/runtime.rb")

file "#{selfhost_source}/dist/runtime.mjs" => [selfhost_source_dist, *selfhost_runtime_deps, *selfhost_filter_deps] do
  Dir.chdir(selfhost_source) do
    sh "npm run build:runtime"
  end
end

# Copy runtime.mjs (transpiled from lib/ruby2js/selfhost/runtime.rb)
file "#{selfhost_dist}/runtime.mjs" => [selfhost_dist, "#{selfhost_source}/dist/runtime.mjs"] do
  # Browser version needs different Prism import path
  content = File.read("#{selfhost_source}/dist/runtime.mjs")
  content.sub!('from "@ruby/prism"', 'from "../prism_browser.mjs"')
  File.write("#{selfhost_dist}/runtime.mjs", content)
  File.chmod(0644, "#{selfhost_dist}/runtime.mjs")
end

# Install selfhost npm dependencies if needed (provides @ruby/prism)
selfhost_prism_source = "#{selfhost_source}/node_modules/@ruby/prism"
file selfhost_prism_source do
  Dir.chdir(selfhost_source) do
    sh "npm install"
  end
end

# Copy @ruby/prism module (needed for browser)
prism_dir = "#{selfhost_dir}/node_modules/@ruby/prism"
directory "#{selfhost_dir}/node_modules/@ruby" => selfhost_dir

file prism_dir => ["#{selfhost_dir}/node_modules/@ruby", selfhost_prism_source] do
  cp_r selfhost_prism_source, prism_dir
end

# Note: index.html is checked into docs/src/demo/selfhost/ directly

# Copy browser-compatible Prism loader
file "#{selfhost_dir}/prism_browser.mjs" => [selfhost_dir, "#{selfhost_source}/prism_browser.mjs"] do
  cp "#{selfhost_source}/prism_browser.mjs", "#{selfhost_dir}/prism_browser.mjs"
end

task :selfhost => [
  "#{selfhost_dir}/prism_browser.mjs",
  "#{selfhost_dist}/walker.mjs",
  "#{selfhost_dist}/converter.mjs",
  "#{selfhost_dist}/namespace.mjs",
  "#{selfhost_dist}/runtime.mjs",
  prism_dir
] do
  # Ensure all files are world-readable (needed for nginx in Docker)
  FileUtils.chmod_R(0644, Dir.glob("#{selfhost_dir}/**/*.mjs"))
  FileUtils.chmod_R(0644, Dir.glob("#{selfhost_dir}/**/*.js"))
  FileUtils.chmod_R(0644, Dir.glob("#{selfhost_dir}/**/*.wasm"))
end

task :default => [
  "#{dest}/index.erb",
  "#{dest}/editor.js",
  "#{dest}/litelement.js",
  "#{dest}/livedemo.js",
  "#{dest}/ruby2js.js",
  :selfhost
]

