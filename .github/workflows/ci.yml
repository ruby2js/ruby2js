name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: [master]

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ===========================================================================
  # Stage 1: Build artifacts (all run in parallel)
  # ===========================================================================

  build-tarballs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install npm dependencies
        run: |
          cd demo/selfhost && npm install
          cd ../../packages/ruby2js-rails && npm install

      - name: Build and pack tarballs
        run: bundle exec rake -f demo/selfhost/Rakefile release

      - name: Upload tarballs
        uses: actions/upload-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs/
          retention-days: 7

  create-blog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install Rails
        run: gem install rails

      - name: Create blog demo
        run: |
          # Point bundler to the checked-out ruby2js repo instead of fetching from GitHub
          bundle config set --global local.ruby2js $GITHUB_WORKSPACE
          test/blog/create-blog artifacts/blog
          tar --exclude='node_modules' -czf artifacts/demo-blog.tar.gz -C artifacts blog

      - name: Upload blog demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-blog
          path: artifacts/demo-blog.tar.gz
          retention-days: 7

  create-chat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install Rails
        run: gem install rails

      - name: Create chat demo
        run: |
          # Point bundler to the checked-out ruby2js repo instead of fetching from GitHub
          bundle config set --global local.ruby2js $GITHUB_WORKSPACE
          test/chat/create-chat artifacts/chat
          tar --exclude='node_modules' -czf artifacts/demo-chat.tar.gz -C artifacts chat

      - name: Upload chat demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-chat
          path: artifacts/demo-chat.tar.gz
          retention-days: 7

  create-photo-gallery:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install Rails
        run: gem install rails

      - name: Create photo_gallery demo
        run: |
          # Point bundler to the checked-out ruby2js repo instead of fetching from GitHub
          bundle config set --global local.ruby2js $GITHUB_WORKSPACE
          test/photo_gallery/create-photo-gallery artifacts/photo_gallery
          tar --exclude='node_modules' -czf artifacts/demo-photo-gallery.tar.gz -C artifacts photo_gallery

      - name: Upload photo_gallery demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-photo-gallery
          path: artifacts/demo-photo-gallery.tar.gz
          retention-days: 7

  create-workflow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install Rails
        run: gem install rails

      - name: Create workflow demo
        run: |
          # Point bundler to the checked-out ruby2js repo instead of fetching from GitHub
          bundle config set --global local.ruby2js $GITHUB_WORKSPACE
          test/workflow/create-workflow artifacts/workflow
          tar --exclude='node_modules' -czf artifacts/demo-workflow.tar.gz -C artifacts workflow

      - name: Upload workflow demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-workflow
          path: artifacts/demo-workflow.tar.gz
          retention-days: 7

  create-notes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install Rails
        run: gem install rails

      - name: Create notes demo
        run: |
          # Point bundler to the checked-out ruby2js repo instead of fetching from GitHub
          bundle config set --global local.ruby2js $GITHUB_WORKSPACE
          test/notes/create-notes artifacts/notes
          tar --exclude='node_modules' -czf artifacts/demo-notes.tar.gz -C artifacts notes

      - name: Upload notes demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-notes
          path: artifacts/demo-notes.tar.gz
          retention-days: 7

  create-astro-blog:
    needs: [build-tarballs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs

      - name: Create astro-blog demo
        run: |
          export RUBY2JS_TARBALL="$GITHUB_WORKSPACE/artifacts/tarballs/ruby2js-beta.tgz"
          export ASTRO_INTEGRATION_TARBALL="$GITHUB_WORKSPACE/artifacts/tarballs/ruby2js-astro-beta.tgz"
          export VITE_PLUGIN_TARBALL="$GITHUB_WORKSPACE/artifacts/tarballs/vite-plugin-ruby2js-beta.tgz"
          export RAILS_TARBALL="$GITHUB_WORKSPACE/artifacts/tarballs/ruby2js-rails-beta.tgz"
          test/astro-blog/create-astro-blog artifacts/astro-blog
          tar --exclude='node_modules' -czf artifacts/demo-astro-blog.tar.gz -C artifacts astro-blog

      - name: Upload astro-blog demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-astro-blog
          path: artifacts/demo-astro-blog.tar.gz
          retention-days: 7

  create-ssg-blog:
    needs: [build-tarballs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs

      - name: Create ssg-blog demo
        run: |
          export CONTENT_ADAPTER_TARBALL="$GITHUB_WORKSPACE/artifacts/tarballs/ruby2js-content-adapter-beta.tgz"
          test/ssg-blog/create-ssg-blog artifacts/ssg-blog
          tar --exclude='node_modules' -czf artifacts/demo-ssg-blog.tar.gz -C artifacts ssg-blog

      - name: Upload ssg-blog demo
        uses: actions/upload-artifact@v4
        with:
          name: demo-ssg-blog
          path: artifacts/demo-ssg-blog.tar.gz
          retention-days: 7

  # ===========================================================================
  # Stage 2: Tests (some run immediately, others depend on Stage 1 artifacts)
  # ===========================================================================

  gem-test:
    # No artifact dependencies - runs immediately with Stage 1
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby: ["3.2", "3.3", "3.4", "4.0"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Run tests
        run: bundle exec rake test

  selfhost-test:
    needs: [build-tarballs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs

      - name: Install from tarballs
        run: |
          cd demo/selfhost
          npm install ../../artifacts/tarballs/ruby2js-beta.tgz

      - name: Run selfhost CI tests
        run: bundle exec rake -f demo/selfhost/Rakefile ci

  smoke-test-blog:
    needs: [build-tarballs, create-blog]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        database: [dexie, sqlite]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs

      - name: Download blog demo
        uses: actions/download-artifact@v4
        with:
          name: demo-blog
          path: artifacts

      - name: Extract blog demo
        run: tar -xzf artifacts/demo-blog.tar.gz -C artifacts

      - name: Install ruby2js-rails from tarball
        run: npm install artifacts/tarballs/ruby2js-beta.tgz artifacts/tarballs/ruby2js-rails-beta.tgz

      - name: Run smoke test
        run: node test/smoke-test.mjs artifacts/blog --database ${{ matrix.database }}

  smoke-test-chat:
    needs: [build-tarballs, create-chat]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        database: [dexie, sqlite]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs

      - name: Download chat demo
        uses: actions/download-artifact@v4
        with:
          name: demo-chat
          path: artifacts

      - name: Extract chat demo
        run: tar -xzf artifacts/demo-chat.tar.gz -C artifacts

      - name: Install ruby2js-rails from tarball
        run: npm install artifacts/tarballs/ruby2js-beta.tgz artifacts/tarballs/ruby2js-rails-beta.tgz

      - name: Run smoke test
        run: node test/smoke-test.mjs artifacts/chat --database ${{ matrix.database }}

  integration-test:
    needs: [build-tarballs, create-blog, create-astro-blog, create-ssg-blog]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        demo: [blog, astro_blog, ssg_blog]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: 'npm'
          cache-dependency-path: test/integration/package-lock.json

      - name: Cache better-sqlite3 prebuild
        uses: actions/cache@v4
        with:
          path: ~/.npm/_prebuilds
          key: ${{ runner.os }}-better-sqlite3-${{ hashFiles('test/integration/package-lock.json') }}

      - name: Download tarballs
        uses: actions/download-artifact@v4
        with:
          name: tarballs
          path: artifacts/tarballs

      - name: Download demo
        uses: actions/download-artifact@v4
        with:
          name: demo-${{ matrix.demo == 'photo_gallery' && 'photo-gallery' || matrix.demo == 'astro_blog' && 'astro-blog' || matrix.demo == 'ssg_blog' && 'ssg-blog' || matrix.demo }}
          path: artifacts

      - name: Run integration tests
        run: |
          cd test/integration
          npm install
          node setup.mjs --local ${{ matrix.demo }}
          # blog uses rails_blog.test.mjs to avoid vitest matching astro_blog.test.mjs
          npm test -- "./${{ matrix.demo == 'blog' && 'rails_blog' || matrix.demo }}.test.mjs"

  # ===========================================================================
  # Stage 2: Deploy (runs in parallel with tests, depends on Stage 1)
  # ===========================================================================

  build-site:
    needs: [build-tarballs, create-blog, create-chat, create-photo-gallery, create-workflow, create-notes, create-astro-blog, create-ssg-blog]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract demo tarballs
        run: |
          for tarball in artifacts/demo-*/demo-*.tar.gz; do
            tar -xzf "$tarball" -C artifacts
          done

      - name: Build browser demos
        run: |
          for demo in blog chat photo_gallery workflow notes; do
            echo "Building $demo for browser..."
            base_path="/ruby2js/${demo//_/-}/"
            # Install fresh tarballs into demo root (where package.json lives in vite-native architecture)
            # Must install all three: ruby2js (transpiler), ruby2js-rails (runtime), vite-plugin-ruby2js (build plugin)
            # Also install browser runtime dependencies: dexie (IndexedDB), turbo/stimulus (Rails UJS), react (ERB rendering)
            (cd "artifacts/$demo" && npm install ../tarballs/ruby2js-beta.tgz ../tarballs/ruby2js-rails-beta.tgz ../tarballs/vite-plugin-ruby2js-beta.tgz dexie @hotwired/turbo @hotwired/stimulus react react-dom)
            # Build from demo root - pure JavaScript via Vite
            (cd "artifacts/$demo" && bin/juntos build -d dexie -t browser --base "$base_path" --sourcemap)
          done

      - name: Build Astro demo
        run: |
          echo "Building astro-blog for GitHub Pages..."
          base_path="/ruby2js/astro-blog/"
          cd artifacts/astro-blog
          # Install ruby2js packages from tarballs (includes vite-plugin for .jsx.rb support)
          npm install ../tarballs/ruby2js-beta.tgz ../tarballs/ruby2js-astro-beta.tgz ../tarballs/vite-plugin-ruby2js-beta.tgz ../tarballs/ruby2js-rails-beta.tgz
          # Build with base path for GitHub Pages
          npm run build -- --base "$base_path"

      - name: Build SSG demo
        run: |
          echo "Building ssg-blog for GitHub Pages..."
          cd artifacts/ssg-blog
          # Install content adapter from tarball
          npm install ../tarballs/ruby2js-content-adapter-beta.tgz
          # Build static site
          npm run build

      - name: Assemble site
        run: |
          mkdir -p _site

          # Copy favicon
          cp docs/src/favicon.ico _site/

          # Copy tarballs to releases/
          mkdir -p _site/releases
          cp artifacts/tarballs/*.tgz _site/releases/
          cp artifacts/demo-*/demo-*.tar.gz _site/releases/

          # Create releases index
          cat > _site/releases/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Ruby2JS Downloads</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; }
              h1 { color: #1a202c; }
              a { color: #2563eb; }
              .section { margin-top: 2rem; padding: 1.5rem; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
              .section h2 { margin: 0 0 1rem 0; }
              ul { margin: 0; padding-left: 1.5rem; }
              li { margin: 0.5rem 0; }
              .back { margin-top: 2rem; }
            </style>
          </head>
          <body>
            <h1>Ruby2JS Downloads</h1>
            <div class="section">
              <h2>NPM Packages</h2>
              <ul>
                <li><a href="ruby2js-beta.tgz">ruby2js-beta.tgz</a> - Core transpiler</li>
                <li><a href="ruby2js-rails-beta.tgz">ruby2js-rails-beta.tgz</a> - Rails integration</li>
                <li><a href="vite-plugin-ruby2js-beta.tgz">vite-plugin-ruby2js-beta.tgz</a> - Vite plugin</li>
                <li><a href="esbuild-plugin-ruby2js-beta.tgz">esbuild-plugin-ruby2js-beta.tgz</a> - esbuild plugin</li>
                <li><a href="ruby2js-astro-beta.tgz">ruby2js-astro-beta.tgz</a> - Astro integration</li>
                <li><a href="ruby2js-svelte-beta.tgz">ruby2js-svelte-beta.tgz</a> - SvelteKit preprocessor</li>
                <li><a href="ruby2js-nuxt-beta.tgz">ruby2js-nuxt-beta.tgz</a> - Nuxt module</li>
                <li><a href="ruby2js-content-adapter-beta.tgz">ruby2js-content-adapter-beta.tgz</a> - Content adapter for SSG</li>
              </ul>
            </div>
            <div class="section">
              <h2>Demo App Tarballs</h2>
              <ul>
                <li><a href="demo-ssg-blog.tar.gz">demo-ssg-blog.tar.gz</a> - SSG blog demo (11ty, static)</li>
                <li><a href="demo-astro-blog.tar.gz">demo-astro-blog.tar.gz</a> - Astro blog demo (islands)</li>
                <li><a href="demo-blog.tar.gz">demo-blog.tar.gz</a> - Blog demo (Rails, CRUD)</li>
                <li><a href="demo-chat.tar.gz">demo-chat.tar.gz</a> - Chat demo (Turbo Streams)</li>
                <li><a href="demo-notes.tar.gz">demo-notes.tar.gz</a> - Notes demo (JSON API)</li>
                <li><a href="demo-photo-gallery.tar.gz">demo-photo-gallery.tar.gz</a> - Photo gallery demo</li>
                <li><a href="demo-workflow.tar.gz">demo-workflow.tar.gz</a> - Workflow builder demo</li>
              </ul>
            </div>
            <p class="back"><a href="../">← Back to demos</a></p>
          </body>
          </html>
          EOF

          # Copy browser demos
          cp -r artifacts/blog/dist _site/blog
          cp -r artifacts/chat/dist _site/chat
          cp -r artifacts/notes/dist _site/notes
          cp -r artifacts/photo_gallery/dist _site/photo-gallery
          cp -r artifacts/workflow/dist _site/workflow
          cp -r artifacts/astro-blog/dist _site/astro-blog
          cp -r artifacts/ssg-blog/_site _site/ssg-blog

          # Create index page
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Ruby2JS Demos</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; }
              h1 { color: #1a202c; }
              h2.section { margin-top: 2rem; margin-bottom: 0.5rem; font-size: 1.1rem; color: #4a5568; }
              .tagline { font-weight: bold; color: #2d3748; margin-bottom: 0.5rem; }
              .demos { display: grid; gap: 1rem; margin-top: 1rem; }
              .demo { padding: 1.5rem; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
              .demo h3 { margin: 0 0 0.5rem 0; }
              .demo h3 a { color: #2563eb; text-decoration: none; }
              .demo h3 a:hover { text-decoration: underline; }
              .demo p { margin: 0; color: #4a5568; }
              .releases { margin-top: 2rem; padding: 1rem; background: #edf2f7; border-radius: 8px; }
              .releases h2 { margin: 0 0 0.5rem 0; font-size: 1rem; }
              .releases a { color: #2563eb; }
            </style>
          </head>
          <body>
            <h1>Ruby2JS Demos</h1>
            <p class="tagline">Start anywhere. Go anywhere. Same patterns throughout.</p>
            <p>Whether you're publishing content or building an application, the same ActiveRecord patterns work everywhere.</p>

            <h2 class="section">Starting from Content</h2>
            <div class="demos">
              <div class="demo">
                <h3><a href="ssg-blog/">SSG Blog</a></h3>
                <p>Pure static. Markdown → HTML. Zero JavaScript. (11ty)</p>
              </div>
              <div class="demo">
                <h3><a href="astro-blog/">Astro Blog</a></h3>
                <p>Content + islands. Client-side CRUD when needed. (Astro)</p>
              </div>
            </div>

            <h2 class="section">Starting from Application</h2>
            <div class="demos">
              <div class="demo">
                <h3><a href="blog/">Blog</a></h3>
                <p>Full CRUD. Deploy to browser, Node, or Edge. (Rails)</p>
              </div>
              <div class="demo">
                <h3><a href="chat/">Chat</a></h3>
                <p>Real-time Turbo Streams, Stimulus controllers. (Rails)</p>
              </div>
              <div class="demo">
                <h3><a href="notes/">Notes</a></h3>
                <p>JSON API, path helper RPC. (Rails + React)</p>
              </div>
            </div>

            <h2 class="section">Adding Capabilities</h2>
            <div class="demos">
              <div class="demo">
                <h3><a href="photo-gallery/">Photo Gallery</a></h3>
                <p>Device APIs: camera, Capacitor, Electron.</p>
              </div>
              <div class="demo">
                <h3><a href="workflow/">Workflow Builder</a></h3>
                <p>Third-party React libraries: React Flow.</p>
              </div>
            </div>

            <div class="releases">
              <h2>Downloads</h2>
              <p><a href="releases/">NPM packages and demo app tarballs</a></p>
            </div>
          </body>
          </html>
          EOF

          # Create 404.html for SPA routing on GitHub Pages
          # When a route like /ruby2js/blog/articles/new is accessed directly,
          # GitHub serves 404.html. This script detects the demo and redirects
          # with the path stored in sessionStorage, which the SPA reads on load.
          cat > _site/404.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <script>
              // GitHub Pages SPA redirect for direct URL access
              // Detects which demo the path belongs to and redirects there
              const path = location.pathname;
              const demos = ['ssg-blog', 'astro-blog', 'blog', 'chat', 'notes', 'photo-gallery', 'workflow'];
              const base = '/ruby2js/';

              // Find which demo this path belongs to
              for (const demo of demos) {
                const demoPath = base + demo + '/';
                if (path.startsWith(demoPath) || path === base + demo) {
                  // Store the full path for the SPA to read after redirect
                  sessionStorage.setItem('spa-redirect-path', path);
                  // Redirect to the demo's index.html
                  location.replace(demoPath);
                  break;
                }
              }
            </script>
          </head>
          <body>
            <p>Redirecting...</p>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: [build-site]
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
